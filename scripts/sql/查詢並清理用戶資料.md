# 查詢並清理用戶資料（Cloudflare D1）

## 步驟 1：查詢您的 User ID

前往 **Supabase Dashboard** > **Authentication** > **Users**，搜尋 `acejou27@gmail.com`，複製 **User ID**（UUID 格式）。

或者使用以下 API 查詢：

```bash
curl "https://your-project.supabase.co/auth/v1/admin/users" \
  -H "apikey: YOUR_SERVICE_ROLE_KEY" \
  -H "Authorization: Bearer YOUR_SERVICE_ROLE_KEY" \
  | jq '.users[] | select(.email == "acejou27@gmail.com") | .id'
```

## 步驟 2：在 Cloudflare D1 Console 執行查詢

前往 **Cloudflare Dashboard** > **Workers & Pages** > **D1** > **quotation-system-db** > **Console**

### 2.1 查看目前資料量

將 `YOUR_USER_ID` 替換為步驟 1 獲取的 User ID：

```sql
SELECT
  (SELECT COUNT(*) FROM quotations WHERE user_id = 'YOUR_USER_ID') as 報價單數量,
  (SELECT COUNT(*) FROM customers WHERE user_id = 'YOUR_USER_ID') as 客戶數量,
  (SELECT COUNT(*) FROM products WHERE user_id = 'YOUR_USER_ID') as 產品數量,
  (SELECT COUNT(*) FROM contracts WHERE user_id = 'YOUR_USER_ID') as 合約數量,
  (SELECT COUNT(*) FROM payment_schedules WHERE user_id = 'YOUR_USER_ID') as 付款數量;
```

### 2.2 清理所有資料

⚠️  **警告：此操作無法復原！**

將 `YOUR_USER_ID` 替換後執行以下 SQL：

```sql
-- 刪除付款排程
DELETE FROM payment_schedules WHERE user_id = 'YOUR_USER_ID';

-- 刪除付款條款
DELETE FROM payment_terms WHERE user_id = 'YOUR_USER_ID';

-- 刪除合約
DELETE FROM contracts WHERE user_id = 'YOUR_USER_ID';

-- 刪除報價單項目
DELETE FROM quotation_items
WHERE quotation_id IN (SELECT id FROM quotations WHERE user_id = 'YOUR_USER_ID');

-- 刪除報價單
DELETE FROM quotations WHERE user_id = 'YOUR_USER_ID';

-- 刪除產品
DELETE FROM products WHERE user_id = 'YOUR_USER_ID';

-- 刪除客戶
DELETE FROM customers WHERE user_id = 'YOUR_USER_ID';

-- 刪除公司成員關係
DELETE FROM company_members WHERE user_id = 'YOUR_USER_ID';

-- 刪除用戶擁有的公司
DELETE FROM companies
WHERE id IN (
  SELECT company_id
  FROM company_members
  WHERE user_id = 'YOUR_USER_ID' AND is_owner = 1
);
```

### 2.3 驗證清理結果

```sql
SELECT
  (SELECT COUNT(*) FROM quotations WHERE user_id = 'YOUR_USER_ID') as 報價單數量,
  (SELECT COUNT(*) FROM customers WHERE user_id = 'YOUR_USER_ID') as 客戶數量,
  (SELECT COUNT(*) FROM products WHERE user_id = 'YOUR_USER_ID') as 產品數量,
  (SELECT COUNT(*) FROM contracts WHERE user_id = 'YOUR_USER_ID') as 合約數量,
  (SELECT COUNT(*) FROM payment_schedules WHERE user_id = 'YOUR_USER_ID') as 付款數量;
```

應該全部顯示 0。

## 步驟 3：使用 wrangler CLI（選擇性）

如果您有安裝 wrangler CLI，可以直接執行：

```bash
# 設定環境變數（從 .env.local 複製）
export USER_ID="你的 User ID"

# 執行清理
pnpm exec wrangler d1 execute quotation-system-db --remote --command "
DELETE FROM payment_schedules WHERE user_id = '$USER_ID';
DELETE FROM payment_terms WHERE user_id = '$USER_ID';
DELETE FROM contracts WHERE user_id = '$USER_ID';
DELETE FROM quotation_items WHERE quotation_id IN (SELECT id FROM quotations WHERE user_id = '$USER_ID');
DELETE FROM quotations WHERE user_id = '$USER_ID';
DELETE FROM products WHERE user_id = '$USER_ID';
DELETE FROM customers WHERE user_id = '$USER_ID';
DELETE FROM company_members WHERE user_id = '$USER_ID';
"
```

## 步驟 4：清理完成

重新登入您的應用程式，儀表板應該顯示全部為 0。

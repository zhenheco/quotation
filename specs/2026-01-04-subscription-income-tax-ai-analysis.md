# ç‡Ÿæ¥­æ‰€å¾—ç¨…ç”³å ± + è¨‚é–±å®šåƒ¹ç³»çµ± + AI è²¡å‹™åˆ†æ

> **å»ºç«‹æ—¥æœŸ**ï¼š2026-01-04
> **ç‹€æ…‹**ï¼šğŸ“‹ è¦æ ¼ç¢ºèªä¸­
> **é ä¼°è¦æ¨¡**ï¼šå¤§å‹åŠŸèƒ½ï¼ˆ3 å€‹æ¨¡çµ„ï¼‰

---

## ğŸ“‹ éœ€æ±‚æ‘˜è¦

ç‚ºå ±åƒ¹/æœƒè¨ˆç³»çµ±æ–°å¢ä¸‰å¤§åŠŸèƒ½æ¨¡çµ„ï¼š

1. **ç‡Ÿæ¥­æ‰€å¾—ç¨…ç”³å ±ï¼ˆæ“´å¤§æ›¸å¯©ï¼‰** - è®“ä¸­å°ä¼æ¥­è‡ªè¡Œè©¦ç®—ã€ç”¢å‡ºç‡Ÿæ‰€ç¨…ç”³å ±è³‡æ–™
2. **è¨‚é–±å®šåƒ¹ç³»çµ±** - 4 å±¤è¨‚é–±æ–¹æ¡ˆï¼ˆå…è²»/å…¥é–€/æ¨™æº–/å°ˆæ¥­ï¼‰+ åŠŸèƒ½é–€æª»æ§åˆ¶
3. **AI è²¡å‹™åˆ†æ** - ç¾é‡‘æµé æ¸¬ã€æ‡‰æ”¶é¢¨éšªè©•ä¼°ã€ç¨…å‹™å„ªåŒ–å»ºè­°

### å®šåƒ¹ç­–ç•¥ï¼ˆåƒè€ƒï¼‰

| æ–¹æ¡ˆ | æœˆè²» | å¹´ç¹³ | ä¸»è¦åŠŸèƒ½ |
|-----|------|------|---------|
| å…è²»ç‰ˆ | $0 | $0 | åŸºç¤å ±åƒ¹ã€50 ç”¢å“ã€20 å®¢æˆ¶ |
| å…¥é–€ç‰ˆ | $299 | $2,990 | 200 ç”¢å“ã€100 å®¢æˆ¶ã€ç‡Ÿæ¥­ç¨…è©¦ç®— |
| æ¨™æº–ç‰ˆ | $799 | $7,990 | 401 åª’é«”æª”ã€ç‡Ÿæ‰€ç¨…ç”³å ±ã€3 å®¶å…¬å¸ |
| å°ˆæ¥­ç‰ˆ | $1,999 | $19,990 | AI åˆ†æã€API å­˜å–ã€10 å®¶å…¬å¸ |

---

## ğŸ¯ é©—æ”¶æ¨™æº–ï¼ˆAcceptance Criteriaï¼‰

### æ¨¡çµ„ Aï¼šè¨‚é–±ç³»çµ±
- [ ] AC-A1: å…¬å¸å»ºç«‹æ™‚è‡ªå‹•å–å¾—å…è²»è¨‚é–±
- [ ] AC-A2: æ”¯æ´ 4 å±¤æ–¹æ¡ˆåˆ‡æ›ï¼ˆå…è²»/å…¥é–€/æ¨™æº–/å°ˆæ¥­ï¼‰
- [ ] AC-A3: æ”¯æ´æœˆç¹³èˆ‡å¹´ç¹³è¨ˆè²»é€±æœŸ
- [ ] AC-A4: åŠŸèƒ½é–€æª»æª¢æŸ¥æ­£ç¢ºé˜»æ“‹æœªæˆæ¬ŠåŠŸèƒ½
- [ ] AC-A5: ç”¨é‡é™åˆ¶ï¼ˆç”¢å“æ•¸ã€å®¢æˆ¶æ•¸ã€å ±åƒ¹å–®/æœˆï¼‰æ­£ç¢ºè¿½è¹¤
- [ ] AC-A6: æ–¹æ¡ˆå‡ç´š/é™ç´šæµç¨‹æ­£å¸¸é‹ä½œ

### æ¨¡çµ„ Bï¼šç‡Ÿæ‰€ç¨…ç”³å ±
- [ ] AC-B1: å¯ç¶­è­·è¡Œæ¥­ç´”ç›Šç‡å°ç…§è¡¨ï¼ˆæ¯å¹´æ›´æ–°ï¼‰
- [ ] AC-B2: è‡ªå‹•åŒ¯ç¸½å¹´åº¦éŠ·é …ç™¼ç¥¨ç‚ºç‡Ÿæ¥­æ”¶å…¥
- [ ] AC-B3: æ­£ç¢ºåˆ¤æ–·æ“´å¤§æ›¸å¯©è³‡æ ¼ï¼ˆâ‰¤3,000 è¬ï¼‰
- [ ] AC-B4: ç¨…é¡è¨ˆç®—ç¬¦åˆèµ·å¾µé¡è¦å‰‡ï¼ˆ12 è¬å…ç¨…ã€20 è¬åŠæ•¸èª²ç¨…ï¼‰
- [ ] AC-B5: å¯é è¦½/åŒ¯å‡ºç”³å ±æ›¸ PDF
- [ ] AC-B6: ç”³å ±è¨˜éŒ„èˆ‡ç¾æœ‰ tax_returns è¡¨æ•´åˆ

### æ¨¡çµ„ Cï¼šAI è²¡å‹™åˆ†æ
- [ ] AC-C1: ç¾é‡‘æµé æ¸¬ç”¢å‡º 3-6 å€‹æœˆé æ¸¬è³‡æ–™
- [ ] AC-C2: æ‡‰æ”¶é¢¨éšªè©•ä¼°ç”¢å‡ºå®¢æˆ¶é¢¨éšªè©•åˆ†èˆ‡å‚¬æ”¶å»ºè­°
- [ ] AC-C3: ç¨…å‹™å„ªåŒ–å»ºè­°ç”¢å‡ºåˆæ³•ç¯€ç¨…æ–¹æ¡ˆ
- [ ] AC-C4: åˆ†æçµæœæ­£ç¢ºå¿«å–ï¼ˆ4-24 å°æ™‚ï¼‰
- [ ] AC-C5: ç¬¦åˆ Cloudflare Workers åŸ·è¡Œé™åˆ¶ï¼ˆä½¿ç”¨ Streamingï¼‰
- [ ] AC-C6: åƒ…å°ˆæ¥­ç‰ˆå¯å­˜å– AI åˆ†æåŠŸèƒ½

---

## ğŸ—‚ï¸ å½±éŸ¿ç¯„åœ

### æ–°å¢æª”æ¡ˆ

#### è³‡æ–™åº«é·ç§»
- `migrations/054_subscription_system.sql` - è¨‚é–±è¡¨æ ¼
- `migrations/055_expanded_audit_income_tax.sql` - ç‡Ÿæ‰€ç¨…è¡¨æ ¼
- `migrations/056_ai_usage_tracking.sql` - AI ç”¨é‡è¿½è¹¤

#### é¡å‹å®šç¾©
- `types/subscription.types.ts` - è¨‚é–±ç³»çµ±é¡å‹
- `types/income-tax.types.ts` - ç‡Ÿæ‰€ç¨…é¡å‹
- `types/financial-analysis.types.ts` - AI åˆ†æé¡å‹

#### è³‡æ–™å­˜å–å±¤ (DAL)
- `lib/dal/subscriptions.ts` - è¨‚é–± CRUD
- `lib/dal/accounting/profit-rates.dal.ts` - ç´”ç›Šç‡ CRUD
- `lib/dal/accounting/expanded-audit.dal.ts` - ç‡Ÿæ‰€ç¨…ç”³å ±
- `lib/dal/financial-analysis/aggregator.dal.ts` - è²¡å‹™è³‡æ–™åŒ¯ç¸½

#### æœå‹™å±¤
- `lib/services/subscription.ts` - è¨‚é–±æ¥­å‹™é‚è¼¯
- `lib/services/accounting/expanded-audit-calculator.ts` - ç‡Ÿæ‰€ç¨…è¨ˆç®—å™¨
- `lib/services/financial-analysis/analysis.service.ts` - AI åˆ†æå”èª¿å™¨
- `lib/services/financial-analysis/ai-client.service.ts` - AI API å®¢æˆ¶ç«¯
- `lib/services/financial-analysis/cache.service.ts` - åˆ†æå¿«å–

#### API è·¯ç”±
- `app/api/subscriptions/route.ts` - è¨‚é–±ç®¡ç†
- `app/api/subscriptions/plans/route.ts` - æ–¹æ¡ˆåˆ—è¡¨
- `app/api/accounting/income-tax/expanded-audit/route.ts` - ç‡Ÿæ‰€ç¨…ç”³å ±
- `app/api/accounting/profit-rates/route.ts` - ç´”ç›Šç‡æŸ¥è©¢
- `app/api/analytics/ai/cash-flow/route.ts` - ç¾é‡‘æµé æ¸¬
- `app/api/analytics/ai/receivable-risk/route.ts` - æ‡‰æ”¶é¢¨éšª
- `app/api/analytics/ai/tax-optimization/route.ts` - ç¨…å‹™å„ªåŒ–

#### UI é é¢
- `app/[locale]/dashboard/accounting/income-tax/` - ç‡Ÿæ‰€ç¨…ç”³å ±é é¢
- `app/[locale]/pricing/` - å®šåƒ¹é é¢
- `components/subscription/` - è¨‚é–±ç›¸é—œå…ƒä»¶
- `components/financial-analysis/` - AI åˆ†æå„€è¡¨æ¿

### ä¿®æ”¹æª”æ¡ˆ
- `lib/api/middleware.ts` - æ“´å±• `withAuth` æ”¯æ´è¨‚é–±æª¢æŸ¥
- `lib/dal/companies.ts` - å…¬å¸å»ºç«‹æ™‚è‡ªå‹•å»ºç«‹å…è²»è¨‚é–±
- `lib/dal/accounting/invoices.dal.ts` - æ–°å¢å¹´åº¦åŒ¯ç¸½å‡½æ•¸
- `messages/zh.json` å’Œ `messages/en.json` - æ–°å¢ i18n ç¿»è­¯

---

## ğŸ§ª æ¸¬è©¦è¨ˆåŠƒ

| æ¸¬è©¦æ¡ˆä¾‹ | å°æ‡‰ AC | é¡å‹ |
|---------|--------|------|
| å»ºç«‹å…¬å¸è‡ªå‹•å–å¾—å…è²»è¨‚é–± | AC-A1 | Integration |
| å‡ç´šæ–¹æ¡ˆå¾ŒåŠŸèƒ½è§£é– | AC-A2, AC-A4 | Integration |
| ç”¨é‡é”é™åˆ¶æ™‚é˜»æ“‹æ–°å¢ | AC-A5 | Unit |
| ç´”ç›Šç‡æŸ¥è©¢æ­£ç¢ºå›å‚³ | AC-B1 | Unit |
| å¹´åº¦éŠ·é …ç™¼ç¥¨æ­£ç¢ºåŒ¯ç¸½ | AC-B2 | Integration |
| ç¸½æ”¶å…¥è¶…é 3000 è¬æ™‚æ‹’çµ•æ“´å¤§æ›¸å¯© | AC-B3 | Unit |
| èª²ç¨…æ‰€å¾— 10 è¬æ™‚ç¨…é¡ç‚º 0 | AC-B4 | Unit |
| èª²ç¨…æ‰€å¾— 15 è¬æ™‚é©ç”¨åŠæ•¸èª²ç¨… | AC-B4 | Unit |
| èª²ç¨…æ‰€å¾— 50 è¬æ™‚é©ç”¨ 20% ç¨…ç‡ | AC-B4 | Unit |
| AI åˆ†æçµæœæ­£ç¢ºå¿«å– | AC-C4 | Integration |
| éå°ˆæ¥­ç‰ˆå­˜å– AI åŠŸèƒ½å›å‚³ 402 | AC-C6 | Integration |

---

## ğŸ“ TDD å¯¦ä½œæ­¥é©Ÿ

### Phase 1: è¨‚é–±ç³»çµ±åŸºç¤

#### Step 1.1: è³‡æ–™åº«é·ç§»
1. ğŸ”´ **Red** - æ¸¬è©¦ `subscription_plans` è¡¨å­˜åœ¨
2. ğŸŸ¢ **Green** - å»ºç«‹ `054_subscription_system.sql`
3. ğŸ”µ **Refactor** - é©—è­‰ RLS æ”¿ç­–

#### Step 1.2: é¡å‹èˆ‡ DAL
1. ğŸ”´ **Red** - æ¸¬è©¦ `getCompanySubscription()` å›å‚³æ­£ç¢ºå‹åˆ¥
2. ğŸŸ¢ **Green** - å¯¦ä½œ `types/subscription.types.ts` å’Œ `lib/dal/subscriptions.ts`
3. ğŸ”µ **Refactor** - å„ªåŒ–æŸ¥è©¢æ•ˆèƒ½

#### Step 1.3: æœå‹™å±¤
1. ğŸ”´ **Red** - æ¸¬è©¦ `createFreeSubscription()` æ­£ç¢ºå»ºç«‹
2. ğŸŸ¢ **Green** - å¯¦ä½œ `lib/services/subscription.ts`
3. ğŸ”µ **Refactor** - æŠ½å–å…±ç”¨é‚è¼¯

#### Step 1.4: Middleware æ“´å±•
1. ğŸ”´ **Red** - æ¸¬è©¦ `withAuth('x', { requiredFeature: 'media_401' })` é˜»æ“‹å…è²»ç”¨æˆ¶
2. ğŸŸ¢ **Green** - æ“´å±• `lib/api/middleware.ts`
3. ğŸ”µ **Refactor** - éŒ¯èª¤è¨Šæ¯æ”¹å–„

---

### Phase 2: ç‡Ÿæ‰€ç¨…ç”³å ±

#### Step 2.1: ç´”ç›Šç‡è¡¨
1. ğŸ”´ **Red** - æ¸¬è©¦ `getProfitRateByCode('6201', 113)` å›å‚³ 6%
2. ğŸŸ¢ **Green** - å»ºç«‹ `055_expanded_audit.sql` å’Œ `profit-rates.dal.ts`
3. ğŸ”µ **Refactor** - æ–°å¢æœå°‹åŠŸèƒ½

#### Step 2.2: ç‡Ÿæ”¶åŒ¯ç¸½
1. ğŸ”´ **Red** - æ¸¬è©¦ `aggregateAnnualRevenue(companyId, 2025)` æ­£ç¢ºåŒ¯ç¸½
2. ğŸŸ¢ **Green** - åœ¨ `invoices.dal.ts` æ–°å¢åŒ¯ç¸½å‡½æ•¸
3. ğŸ”µ **Refactor** - ä½¿ç”¨ View å„ªåŒ–

#### Step 2.3: æ“´å¤§æ›¸å¯©è¨ˆç®—å™¨
1. ğŸ”´ **Red** - æ¸¬è©¦å„ç¨®ç¨…é¡è¨ˆç®—æƒ…å¢ƒ
2. ğŸŸ¢ **Green** - å¯¦ä½œ `expanded-audit-calculator.ts`
3. ğŸ”µ **Refactor** - æŠ½å–å¸¸æ•¸

#### Step 2.4: API èˆ‡ UI
1. ğŸ”´ **Red** - æ¸¬è©¦ API ç«¯é»å›å‚³æ­£ç¢ºæ ¼å¼
2. ğŸŸ¢ **Green** - å¯¦ä½œè·¯ç”±å’Œé é¢
3. ğŸ”µ **Refactor** - åŠ å…¥ i18n

---

### Phase 3: AI è²¡å‹™åˆ†æ

#### Step 3.1: è³‡æ–™é è™•ç†
1. ğŸ”´ **Red** - æ¸¬è©¦ `getCashFlowHistory()` å›å‚³çµæ§‹
2. ğŸŸ¢ **Green** - å¯¦ä½œ `aggregator.dal.ts`
3. ğŸ”µ **Refactor** - å„ªåŒ–æŸ¥è©¢

#### Step 3.2: AI æœå‹™
1. ğŸ”´ **Red** - Mock æ¸¬è©¦ AI å›æ‡‰è§£æ
2. ğŸŸ¢ **Green** - å¯¦ä½œ `ai-client.service.ts`
3. ğŸ”µ **Refactor** - æ–°å¢ fallback

#### Step 3.3: å¿«å–å±¤
1. ğŸ”´ **Red** - æ¸¬è©¦å¿«å–å‘½ä¸­/å¤±æ•ˆ
2. ğŸŸ¢ **Green** - å¯¦ä½œ `cache.service.ts`
3. ğŸ”µ **Refactor** - èª¿æ•´ TTL

#### Step 3.4: API èˆ‡ Streaming
1. ğŸ”´ **Red** - æ¸¬è©¦ Streaming å›æ‡‰
2. ğŸŸ¢ **Green** - å¯¦ä½œ API è·¯ç”±ï¼ˆä½¿ç”¨ EventStreamï¼‰
3. ğŸ”µ **Refactor** - æˆæœ¬æ§åˆ¶

---

## ğŸ“Š é æœŸæ¸¬è©¦è¦†è“‹ç‡

- è¨‚é–±æœå‹™ï¼š90%+
- ç‡Ÿæ‰€ç¨…è¨ˆç®—å™¨ï¼š95%+
- AI åˆ†ææœå‹™ï¼š80%+
- API ç«¯é»ï¼š85%+

---

## âš ï¸ æŠ€è¡“é¢¨éšªèˆ‡å°ç­–

| é¢¨éšª | å½±éŸ¿ç¨‹åº¦ | å°ç­– |
|-----|---------|-----|
| Cloudflare Workers AI å‘¼å«è¶…æ™‚ | ğŸ”´ é«˜ | ä½¿ç”¨ Streaming + å¿«å– |
| è¡Œæ¥­ç´”ç›Šç‡æ¯å¹´æ›´æ–° | ğŸŸ¡ ä¸­ | å¾è²¡æ”¿éƒ¨ç¶²ç«™çˆ¬å–ä¸¦å»ºç«‹æ‰¹æ¬¡åŒ¯å…¥ |
| è¨‚é–±ç‹€æ…‹èˆ‡ RBAC è¡çª | ğŸŸ¡ ä¸­ | æ˜ç¢ºå„ªå…ˆé †åºï¼ˆè¨‚é–± > RBACï¼‰ |
| AI æˆæœ¬å¤±æ§ | ğŸŸ¡ ä¸­ | æœˆåº¦ç”¨é‡é™åˆ¶ + å¿«å– |

---

## ğŸ“¥ è¡Œæ¥­ç´”ç›Šç‡è³‡æ–™ä¾†æº

### è³‡æ–™å–å¾—æ–¹å¼
1. **ä¾†æº**ï¼šè²¡æ”¿éƒ¨ç¨…å‹™å…¥å£ç¶² - æ“´å¤§æ›¸å¯©ç´”ç›Šç‡æ¨™æº–
2. **ç¶²å€**ï¼š`https://www.etax.nat.gov.tw/etwmain/tax-info/understanding/tax-knowledge-article/aXG9Drp`
3. **æ ¼å¼**ï¼šè²¡æ”¿éƒ¨æä¾› Excel æª”ä¸‹è¼‰

### å¯¦ä½œæ–¹æ¡ˆ
- å»ºç«‹çˆ¬èŸ²è…³æœ¬å¾è²¡æ”¿éƒ¨ä¸‹è¼‰å¹´åº¦ç´”ç›Šç‡ Excel
- ä½¿ç”¨ `xlsx` å¥—ä»¶è§£æ Excel è½‰ç‚º JSON
- æä¾› Admin API æ‰¹æ¬¡åŒ¯å…¥åˆ° `industry_profit_rates` è¡¨
- åˆå§‹å…§å»ºç´„ 50 å€‹å¸¸è¦‹è¡Œæ¥­ä»£ç¢¼ä½œç‚º seed data

---

## ğŸ”— é—œéµæª”æ¡ˆè·¯å¾‘

### ç¾æœ‰æª”æ¡ˆï¼ˆéœ€é–±è®€ç†è§£ï¼‰
- `/lib/api/middleware.ts` - API æˆæ¬Šä¸­é–“ä»¶
- `/lib/dal/accounting/invoices.dal.ts` - ç™¼ç¥¨ DAL
- `/lib/services/accounting/tax-report.service.ts` - 401 ç¨…å‹™æœå‹™
- `/lib/services/accounting/media-file-generator.ts` - 401 åª’é«”æª”ç”¢ç”Ÿå™¨
- `/lib/cloudflare/ai-gateway.ts` - AI Gateway æ•´åˆ
- `/migrations/044_accounting_core_tables.sql` - æœƒè¨ˆè¡¨çµæ§‹

### æ–°å»ºæª”æ¡ˆé †åº
1. é·ç§»æª”æ¡ˆ (`054`, `055`, `056`)
2. é¡å‹å®šç¾© (`types/*.types.ts`)
3. DAL å±¤ (`lib/dal/*.ts`)
4. æœå‹™å±¤ (`lib/services/*.ts`)
5. API è·¯ç”± (`app/api/**`)
6. UI é é¢ (`app/[locale]/**`)

---

## ğŸ’³ é‡‘æµæ•´åˆ

### ä»˜æ¬¾æ–¹å¼
- ä½¿ç”¨ affiliate å°ˆæ¡ˆçš„ PayUNi SDK
- æ”¯æ´ä¿¡ç”¨å¡ã€ATM è½‰å¸³

### è¨‚é–±æµç¨‹
1. ä½¿ç”¨è€…é¸æ“‡æ–¹æ¡ˆ â†’ ç”¢ç”Ÿè¨‚å–®
2. è·³è½‰ PayUNi ä»˜æ¬¾é é¢
3. ä»˜æ¬¾å®Œæˆ â†’ Webhook å›èª¿
4. æ›´æ–°è¨‚é–±ç‹€æ…‹ â†’ é–‹é€šåŠŸèƒ½

---

## âœ… å®Œæˆæ¢ä»¶ï¼ˆDone Criteriaï¼‰

ç•¶æ»¿è¶³ä»¥ä¸‹æ¢ä»¶æ™‚ï¼Œæ­¤ä»»å‹™è¦–ç‚º **Completed**ï¼š

- [ ] æ‰€æœ‰é©—æ”¶æ¨™æº–ï¼ˆAC-A1 åˆ° AC-C6ï¼‰é€šé
- [ ] æ‰€æœ‰æ¸¬è©¦æ¡ˆä¾‹ç¶ ç‡ˆï¼Œè¦†è“‹ç‡é”æ¨™
- [ ] Vercel éƒ¨ç½²æˆåŠŸ
- [ ] ç„¡ TypeScript éŒ¯èª¤ï¼ˆ`pnpm run typecheck`ï¼‰
- [ ] ESLint é€šéï¼ˆ`pnpm run lint`ï¼‰
- [ ] ç¨‹å¼ç¢¼å·²æäº¤ä¸¦æ¨é€
- [ ] i18n ç¿»è­¯å®Œæˆï¼ˆzh/enï¼‰

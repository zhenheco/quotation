# 電子發票整合需求規格書

> **版本**：1.0
> **建立日期**：2026-01-02
> **狀態**：待開發

---

## 1. 需求概述

### 1.1 背景

用戶需要將財政部電子發票平台的進銷項發票資料匯入系統，並產出 401 營業稅媒體申報檔案（TXT 格式），以完成雙月營業稅申報流程。

### 1.2 目標

```
用戶操作流程：
1. 登入財政部電子發票平台下載 Excel（每雙月一次）
2. 匯入本系統（自動解析、產生會計分錄）
3. 下載 401 媒體申報 TXT 檔
4. 匯入財政部「營業稅離線建檔系統」
5. 系統自動產生 .TET（申報書）並上傳
```

### 1.3 範圍

**納入範圍**：
- 財政部 Excel 匯入（進項/銷項發票）
- 401 媒體申報 TXT 檔案產出
- 前端 UI 整合

**排除範圍**：
- 403 零稅率申報（Phase 2）
- 自動從財政部 API 下載（需 Turnkey，法規限制）
- .TET 申報書產生（由財政部系統處理）

---

## 2. 401 媒體申報檔格式規格

### 2.1 基本資訊

| 項目 | 說明 |
|-----|------|
| **檔案名稱** | `{統一編號}.TXT`（例：`12345678.TXT`）|
| **每筆長度** | 固定 **81 Bytes**（81 個半形字元）|
| **編碼格式** | **UTF-8**（自民國108年起強制）|
| **換行符號** | 無換行，每 81 字元為一筆資料連續排列 |
| **資料類型** | 純文字，數字靠右補零，文字靠左補空白 |

### 2.2 欄位定義（81 Bytes）

| 序號 | 欄位名稱 | 位置 | 長度 | 型態 | 說明 |
|-----|---------|------|------|------|------|
| 1 | 格式代號 | 1-2 | 2 | 9(2) | 進銷項類型，見 2.3 |
| 2 | 稅籍編號 | 3-11 | 9 | 9(9) | 申報營業人的稅籍編號（統編8碼+分支碼1碼）|
| 3 | 流水號 | 12-18 | 7 | X(7) | 資料序號，從 0000001 開始，不可重複 |
| 4 | 資料所屬年月 | 19-23 | 5 | 9(5) | 民國年3碼+月2碼，如 `11312` |
| 5 | 買受人統編/發票訖號 | 24-31 | 8 | X(8) | 依情境不同，見 2.4 |
| 6 | 銷售人統編/彙總張數 | 32-39 | 8 | X(8) | 依情境不同，見 2.4 |
| 7 | 發票字軌號碼 | 40-49 | 10 | X(10) | 2碼英文+8碼數字，如 `AB12345678` |
| 8 | 銷售額 | 50-61 | 12 | 9(12) | 不含稅金額，靠右補零 |
| 9 | 課稅別 | 62 | 1 | 9(1) | 1=應稅, 2=零稅率, 3=免稅 |
| 10 | 稅額 | 63-72 | 10 | 9(10) | 營業稅額，靠右補零 |
| 11 | 扣抵代號 | 73 | 1 | 9(1) | 進項專用：1=可扣抵, 2=不可扣抵, 3=可扣抵固定資產, 4=不可扣抵固定資產 |
| 12 | 彙加註記 | 74 | 1 | X(1) | 空白=逐筆, A=彙總 |
| 13 | 通關方式 | 75 | 1 | 9(1) | 零稅率專用：1=經海關, 2=未經海關 |
| 14 | 空白保留 | 76-81 | 6 | X(6) | 全部填空白 |

**總計**：2+9+7+5+8+8+10+12+1+10+1+1+1+6 = **81 Bytes**

### 2.3 格式代號對照表

#### 進項（21~29）

| 代號 | 說明 | 常見情境 |
|-----|------|---------|
| **21** | 三聯式、電子計算機統一發票 | B2B 進貨發票 |
| **22** | 二聯式收銀機發票、載有稅額之其他憑證 | 零售購買、火車票高鐵票 |
| **23** | 三聯式發票之進貨退出或折讓證明單 | 退貨折讓（21、25的折讓）|
| **24** | 二聯式發票之進貨退出或折讓證明單 | 退貨折讓（22的折讓）|
| **25** | 三聯式收銀機發票、電子發票（稅額≤500可彙總）| **電子發票進項（最常用）** |
| **26** | 彙總三聯式、電子計算機發票（稅額≤500）| 小額發票彙總 |
| **27** | 彙總二聯式發票、其他憑證（稅額≤500）| 小額憑證彙總 |
| **28** | 海關代徵營業稅繳納證 | 進口貨物 |
| **29** | 海關退還溢繳營業稅 | 進口退稅 |

#### 銷項（31~38）

| 代號 | 說明 | 常見情境 |
|-----|------|---------|
| **31** | 三聯式、電子計算機統一發票 | B2B 銷貨發票 |
| **32** | 二聯式、二聯式收銀機發票 | B2C 零售發票 |
| **33** | 三聯式發票之銷貨退回或折讓證明單 | 退貨折讓（31、35的折讓）|
| **34** | 二聯式發票之銷貨退回或折讓證明單 | 退貨折讓（32、36的折讓）|
| **35** | 三聯式收銀機發票、電子發票 | **電子發票銷項（最常用）** |
| **36** | 免用統一發票 | 小規模營業人 |
| **37** | 特種稅額銷項憑證 | 特種稅額計算 |
| **38** | 特種稅額銷貨退回或折讓 | 特種稅額折讓 |

### 2.4 欄位填寫規則

#### 稅籍編號（欄位2）
- 9 位數字
- 格式：`統一編號(8碼) + 分支機構碼(1碼)`
- 總公司分支機構碼為 `0`，例：`123456780`

#### 流水號（欄位3）
- 7 位英數字
- 從 `0000001` 開始遞增
- 同一申報檔內不可重複

#### 資料所屬年月（欄位4）
- 格式：`YYYММ`（民國年3碼 + 月份2碼）
- 範例：`11312` = 民國113年12月
- 民國年 = 西元年 - 1911

#### 買受人統編/發票訖號（欄位5）

| 情境 | 內容 |
|-----|------|
| 進項資料 | 填自己公司統編（8碼）|
| 銷項資料（逐筆）| 填買方統編，無統編則空白 |
| 銷項資料（彙總）| 填發票訖號（8碼數字）|

#### 銷售人統編/彙總張數（欄位6）

| 情境 | 內容 |
|-----|------|
| 進項資料 | 填賣方統編（8碼）|
| 銷項資料 | 填自己公司統編（8碼）|
| 彙總資料 | 填彙總張數（右靠補零）|

#### 課稅別（欄位9）

| 代號 | 說明 |
|-----|------|
| 1 | 應稅（5%營業稅）|
| 2 | 零稅率 |
| 3 | 免稅 |
| 9 | 特種稅額（金融保險業等）|

#### 扣抵代號（欄位11）

**僅進項資料需填，銷項資料留空白**

| 代號 | 說明 |
|-----|------|
| 1 | 得扣抵進項稅額 |
| 2 | 不得扣抵進項稅額（依營業稅法§19）|
| 3 | 得扣抵之固定資產 |
| 4 | 不得扣抵之固定資產 |

### 2.5 範例資料

#### 銷項發票範例

發票資訊：
- 發票號碼：AB-12345678
- 日期：2024/12/15
- 買方統編：53593495
- 賣方統編：83081080
- 銷售額：100,000
- 稅額：5,000

媒體檔內容（81 bytes）：
```
3583081080000000111312535934958308108012345678000000100000010000005000 1
```

欄位拆解：
| 位置 | 內容 | 欄位 | 說明 |
|-----|------|------|------|
| 1-2 | `35` | 格式代號 | 電子發票銷項 |
| 3-11 | `830810800` | 稅籍編號 | 自己的稅籍（統編+0）|
| 12-18 | `0000001` | 流水號 | 第1筆 |
| 19-23 | `11312` | 年月 | 民國113年12月 |
| 24-31 | `53593495` | 買受人統編 | 買方統編 |
| 32-39 | `83081080` | 銷售人統編 | 自己統編 |
| 40-49 | `AB12345678` | 發票字軌 | 發票號碼 |
| 50-61 | `000000100000` | 銷售額 | 100,000元 |
| 62 | `1` | 課稅別 | 應稅 |
| 63-72 | `0000005000` | 稅額 | 5,000元 |
| 73 | ` ` | 扣抵代號 | 銷項不填 |
| 74 | ` ` | 彙加註記 | 逐筆 |
| 75 | ` ` | 通關方式 | 非零稅率 |
| 76-81 | `      ` | 空白 | 保留欄位 |

---

## 3. 財政部 Excel 匯入格式

### 3.1 預期欄位（需確認實際格式）

進項發票 Excel：
| 欄位名稱 | 對應系統欄位 | 說明 |
|---------|-------------|------|
| 發票號碼 | number | 例：AB-12345678 |
| 發票日期 | date | 例：113/12/15 或 2024/12/15 |
| 賣方統一編號 | counterparty_tax_id | 供應商統編 |
| 賣方名稱 | counterparty_name | 供應商名稱 |
| 銷售額 | untaxed_amount | 未稅金額 |
| 稅額 | tax_amount | 營業稅額 |
| 總計 | total_amount | 含稅金額 |

銷項發票 Excel：
| 欄位名稱 | 對應系統欄位 | 說明 |
|---------|-------------|------|
| 發票號碼 | number | 例：AB-12345678 |
| 發票日期 | date | 例：113/12/15 或 2024/12/15 |
| 買方統一編號 | counterparty_tax_id | 客戶統編 |
| 買方名稱 | counterparty_name | 客戶名稱 |
| 銷售額 | untaxed_amount | 未稅金額 |
| 稅額 | tax_amount | 營業稅額 |
| 總計 | total_amount | 含稅金額 |

### 3.2 日期格式處理

需支援多種日期格式：
- 民國年格式：`113/12/15`、`113-12-15`
- 西元年格式：`2024/12/15`、`2024-12-15`
- Excel 日期序號：`45641`（需轉換）

### 3.3 金額格式處理

需處理：
- 千分位逗號：`100,000` → `100000`
- 負數（折讓）：`-5000`
- 空值：視為 0

---

## 4. 系統架構設計

### 4.1 新增檔案

```
lib/services/accounting/
├── mof-excel-parser.ts          # 財政部 Excel 解析器
├── media-file-generator.ts      # 401 媒體檔產生器
└── index.ts                     # 匯出更新

app/api/accounting/reports/tax/
└── media/
    └── route.ts                 # 媒體檔下載 API

__tests__/services/accounting/
├── mof-excel-parser.test.ts     # 解析器測試
└── media-file-generator.test.ts # 產生器測試
```

### 4.2 修改檔案

```
lib/services/accounting/tax-report.service.ts
  → 新增 generateMediaFile401()

app/[locale]/accounting/invoices/InvoiceUpload.tsx
  → 新增匯入模式選擇（標準 / 財政部進項 / 財政部銷項）

app/[locale]/accounting/reports/TaxReportDashboard.tsx
  → 新增「下載媒體檔」按鈕

hooks/accounting/index.ts
  → 新增 useDownloadMediaFile hook

messages/zh.json, messages/en.json
  → 新增 i18n 翻譯鍵
```

### 4.3 API 設計

#### GET /api/accounting/reports/tax/media

產生並下載 401 媒體申報檔。

**Request Parameters**：
| 參數 | 類型 | 必填 | 說明 |
|-----|------|------|------|
| company_id | string | Y | 公司 ID |
| year | number | Y | 年度（西元年）|
| bi_month | number | Y | 雙月期（1-6）|
| type | string | N | 申報類型，預設 `401` |

**Response**：
```
Content-Type: text/plain; charset=utf-8
Content-Disposition: attachment; filename="12345678.TXT"
```

**Error Response**：
```json
{
  "error": "Missing required parameter: company_id"
}
```

---

## 5. 驗收標準

### 5.1 功能驗收

- [ ] AC1: 可解析財政部 Excel 格式（進項/銷項）並正確對應欄位
- [ ] AC2: 匯入的發票資料正確儲存到 `acc_invoices` 表
- [ ] AC3: 產出的 TXT 檔符合 81 字節固定格式規範
- [ ] AC4: TXT 檔可成功匯入財政部「營業稅離線建檔系統」
- [ ] AC5: 前端可選擇「財政部匯入」模式並預覽資料
- [ ] AC6: 前端可下載 401 媒體申報 TXT 檔

### 5.2 技術驗收

- [ ] 單元測試覆蓋率 > 90%
- [ ] `pnpm run typecheck` 無錯誤
- [ ] `pnpm run lint` 無警告
- [ ] 所有 API 有錯誤處理

---

## 6. 測試案例

| 測試案例 | 對應 AC | 類型 |
|---------|--------|------|
| should parse MOF sales Excel row correctly | AC1 | Unit |
| should parse MOF purchase Excel row correctly | AC1 | Unit |
| should return error for missing required fields | AC1 | Unit |
| should handle ROC date format (113/12/15) | AC1 | Unit |
| should handle CE date format (2024/12/15) | AC1 | Unit |
| should save imported invoices to database | AC2 | Integration |
| should generate exactly 81 bytes per record | AC3 | Unit |
| should use format code 35 for e-invoice sales | AC3 | Unit |
| should use format code 25 for e-invoice purchases | AC3 | Unit |
| should pad amounts with leading zeros | AC3 | Unit |
| should convert to ROC year correctly (2024 → 113) | AC3 | Unit |
| should leave deduction code blank for sales | AC3 | Unit |
| should render import mode selector | AC5 | Component |
| should trigger file download on button click | AC6 | E2E |

---

## 7. 參考資源

1. **財政部法規**：[營業稅電子資料申報繳稅作業要點](https://law-out.mof.gov.tw/LawContent.aspx?id=GL009478)
2. **申報軟體下載**：[財政部電子申報繳稅服務網](https://tax.nat.gov.tw/alltax-download.html?id=2)
3. **電子發票平台**：[財政部電子發票整合服務平台](https://www.einvoice.nat.gov.tw/)

---

## 附錄 A：欄位位置快速對照表

```
位置:  1  2  3         11 12       18 19    23 24       31 32       39 40          49 50            61 62 63          72 73 74 75 76       81
      ├──┼──┼─────────┼──┼────────┼──┼─────┼──┼─────────┼──┼─────────┼──┼───────────┼──┼─────────────┼──┼──┼──────────┼──┼──┼──┼──┼───────┤
欄位:  格式 │ 稅籍編號  │  流水號   │ 年月 │ 買受人統編 │ 銷售人統編 │  發票字軌   │   銷售額      │課│   稅額     │扣│彙│通│  空白  │
      代號 │   (9)    │   (7)    │ (5) │   (8)    │   (8)    │   (10)    │    (12)     │稅│   (10)    │抵│加│關│  (6)  │
      (2)  │          │          │     │          │          │           │             │別│           │  │  │  │       │
```

name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - '**'  # æ‰€æœ‰åˆ†æ”¯ push éƒ½è§¸ç™¼éƒ¨ç½²
  pull_request:
    branches:
      - '**'  # æ‰€æœ‰ PR éƒ½è§¸ç™¼éƒ¨ç½²

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Workers

    # è¨­å®šç’°å¢ƒåç¨±ï¼ˆç”¨æ–¼ Cloudflare Workers ç’°å¢ƒå€åˆ†ï¼‰
    environment:
      name: ${{ github.ref_name }}
      url: https://quotation-system-${{ github.ref_name }}.acejou27.workers.dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Build project
        run: pnpm run build
        env:
          # Supabase ç’°å¢ƒè®Šæ•¸ï¼ˆå»ºç½®æ™‚éœ€è¦ï¼‰
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          # å…¶ä»–å»ºç½®æ™‚å¯èƒ½éœ€è¦çš„ç’°å¢ƒè®Šæ•¸
          NODE_ENV: production

      - name: Set deployment name
        id: deployment-name
        run: |
          # å°‡åˆ†æ”¯åç¨±è½‰æ›ç‚ºåˆæ³•çš„ worker åç¨±ï¼ˆç§»é™¤ç‰¹æ®Šå­—å…ƒï¼‰
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]')
          if [ "$BRANCH_NAME" = "main" ]; then
            echo "WORKER_NAME=quotation-system" >> $GITHUB_OUTPUT
          else
            echo "WORKER_NAME=quotation-system-$BRANCH_NAME" >> $GITHUB_OUTPUT
          fi
          echo "Deploying to: $(cat $GITHUB_OUTPUT | grep WORKER_NAME)"

      - name: Deploy to Cloudflare Workers
        run: |
          # ä½¿ç”¨å‹•æ…‹ worker åç¨±éƒ¨ç½²
          pnpm exec wrangler deploy --name ${{ steps.deployment-name.outputs.WORKER_NAME }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: f9916b95d011e8ad2a3fe10883053b0f

      - name: Comment PR with deployment URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ éƒ¨ç½²å®Œæˆï¼\n\né è¦½ç¶²å€ï¼šhttps://${{ steps.deployment-name.outputs.WORKER_NAME }}.acejou27.workers.dev`
            })

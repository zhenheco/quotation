# è¨˜å¸³é€š - è»Ÿé«”è¨­è¨ˆè¦æ ¼æ›¸ (SDD)

> **ç‰ˆæœ¬**ï¼š1.2  
> **å»ºç«‹æ—¥æœŸ**ï¼š2026-01-09  
> **æ›´æ–°æ—¥æœŸ**ï¼š2026-01-09  
> **å°ˆæ¡ˆä»£è™Ÿ**ï¼šQuote24 (è¨˜å¸³é€š)  
> **ç¶²å€**ï¼šhttps://quote24.cc

---

## 1. ç³»çµ±æ¦‚è¿°

### 1.1 å°ˆæ¡ˆç›®æ¨™

å»ºç«‹ä¸€å¥—å°ˆç‚ºå°ç£ä¸­å°ä¼æ¥­è¨­è¨ˆçš„é›²ç«¯è¨˜å¸³èˆ‡å ±ç¨…æ•´åˆç³»çµ±ï¼Œè®“å¹´ç‡Ÿæ”¶ 3,000 è¬ä»¥ä¸‹çš„å¾®å‹ä¼æ¥­èƒ½å¤ è‡ªä¸»å®Œæˆè¨˜å¸³ã€å ±åƒ¹ã€è²¡å‹™å ±è¡¨ç”¢å‡ºåŠç¨…å‹™ç”³å ±ï¼Œä¸å†ä¾è³´å¤–éƒ¨è¨˜å¸³å£«æˆ–æœƒè¨ˆäº‹å‹™æ‰€ã€‚

### 1.2 ç›®æ¨™å®¢ç¾¤

| ç‰¹å¾µ | æè¿° |
|------|------|
| **ä¼æ¥­è¦æ¨¡** | å¹´ç‡Ÿæ”¶ NT$3,000 è¬ä»¥ä¸‹ |
| **å“¡å·¥äººæ•¸** | 10 äººä»¥ä¸‹çš„å¾®å‹ä¼æ¥­ |
| **ç¾æ³ç—›é»** | ä½¿ç”¨ Excel è¨˜å¸³ã€æ¯æœˆèŠ± NT$2,000-5,000 è«‹è¨˜å¸³å£« |
| **æ ¸å¿ƒéœ€æ±‚** | æƒ³çœéŒ¢è‡ªå·±è™•ç†ï¼Œä½†ä¸æœƒå ±ç¨… |

### 1.3 ç”¢å“åƒ¹å€¼ä¸»å¼µ

> **ã€Œè¨˜å¸³ + å ±ç¨…ï¼Œä¸€ç«™æå®šã€**  
> ä¸åªæ˜¯è¨˜å¸³è»Ÿé«”ï¼Œæ›´æ˜¯ä½ çš„é›²ç«¯æœƒè¨ˆéƒ¨é–€

| å‚³çµ±åšæ³• | ä½¿ç”¨è¨˜å¸³é€š |
|---------|-----------|
| è¨˜å¸³å£«æœˆè²» NT$2,000-5,000 | Entry æ–¹æ¡ˆ NT$199/æœˆ |
| æœƒè¨ˆäº‹å‹™æ‰€å¹´è²» NT$60,000+ | Pro æ–¹æ¡ˆ NT$2,499/æœˆ |
| Excel è¨˜å¸³ + æ‰‹å‹•å ±ç¨… | è‡ªå‹•ç”¢å‡ºç”³å ±æª”æ¡ˆ |

### 1.4 ç³»çµ±ç¯„åœ

| æ¨¡çµ„ | åŠŸèƒ½æè¿° | æ–¹æ¡ˆé™åˆ¶ |
|------|---------|---------|
| **éŠ·å”®å ±åƒ¹** | å ±åƒ¹å–® â†’ è¨‚å–® â†’ å‡ºè²¨å–® â†’ ç™¼ç¥¨ å®Œæ•´æµç¨‹ | å…¨æ–¹æ¡ˆ |
| **å®¢æˆ¶ç®¡ç†** | å®¢æˆ¶/å» å•†è³‡æ–™ç¶­è­·ã€è¯çµ¡äººç®¡ç† | å…¨æ–¹æ¡ˆ |
| **è²¡å‹™å ±è¡¨** | è³‡ç”¢è² å‚µè¡¨ã€æç›Šè¡¨ã€ç¾é‡‘æµé‡è¡¨ã€æ‡‰æ”¶æ‡‰ä»˜æ˜ç´° | å…¨æ–¹æ¡ˆ |
| **é€²éŠ·å­˜** | åº«å­˜ç®¡ç†ã€é€²éŠ·å­˜å ±è¡¨ | å…¨æ–¹æ¡ˆ |
| **é€šçŸ¥æé†’** | Email é€šçŸ¥ + ç¶²ç«™å…§é€šçŸ¥ä¸­å¿ƒ | å…¨æ–¹æ¡ˆ |
| **é›»å­ç™¼ç¥¨** | Payuni ä¸²æ¥ï¼ŒB2B/B2C ç™¼ç¥¨é–‹ç«‹ | Standard+ |
| **ç‡Ÿæ¥­ç¨…ç”³å ±** | 401 ç”³å ± Media æª” + PDF é è¦½ | Standard+ |
| **ç‡Ÿæ‰€ç¨…è¨ˆç®—** | æ“´å¤§æ›¸å¯©è©¦ç®— + ç”³å ±æ›¸è¡¨ | Pro |

---

## 2. å•†æ¥­æ¨¡å¼èˆ‡å®šåƒ¹

### 2.1 è¨‚é–±æ–¹æ¡ˆ

| æ–¹æ¡ˆ | æœˆè²» | ç›®æ¨™ç”¨æˆ¶ | æ ¸å¿ƒåƒ¹å€¼ |
|------|-----:|---------|---------|
| **Entry** | NT$199 | å€‹äººå·¥ä½œå®¤ã€å‰›å‰µæ¥­ | è¼•é‡è¨˜å¸³å…¥é–€ |
| **Standard** | NT$899 | å°å‹å…¬å¸ã€æœ‰å ±ç¨…éœ€æ±‚ | å–ä»£è¨˜å¸³å£« |
| **Pro** | NT$2,499 | æˆé•·å‹ä¼æ¥­ã€å®Œæ•´éœ€æ±‚ | å–ä»£æœƒè¨ˆäº‹å‹™æ‰€ |

### 2.2 åŠŸèƒ½çŸ©é™£

| åŠŸèƒ½ | Entry | Standard | Pro |
|------|:-----:|:--------:|:---:|
| ğŸ“ éŠ·å”®å ±åƒ¹ç³»çµ±ï¼ˆç„¡é™ï¼‰ | âœ… | âœ… | âœ… |
| ğŸ“Š è²¡å‹™å ±è¡¨ | âœ… | âœ… | âœ… |
| ğŸ‘¥ å®¢æˆ¶/å» å•†è³‡æ–™ï¼ˆç„¡é™ï¼‰ | âœ… | âœ… | âœ… |
| ğŸ“¦ é€²éŠ·å­˜ç®¡ç† | âœ… | âœ… | âœ… |
| ğŸ“ æª”æ¡ˆé™„ä»¶ä¸Šå‚³ | âœ… | âœ… | âœ… |
| ğŸ”„ è³‡æ–™åŒ¯å…¥åŒ¯å‡º | âœ… | âœ… | âœ… |
| ğŸ”” ç¶²ç«™å…§é€šçŸ¥ä¸­å¿ƒ | âœ… | âœ… | âœ… |
| ğŸ“§ Email é€šçŸ¥æé†’ | âœ… | âœ… | âœ… |
| ğŸ‘¤ ä½¿ç”¨è€…å¸³è™Ÿ | 1 äºº | 3 äºº | ç„¡é™ |
| ğŸ” ä½¿ç”¨è€…æ¬Šé™ç®¡ç† | åƒ…ç®¡ç†å“¡ | ç®¡ç†å“¡/æœƒè¨ˆ/æ¥­å‹™ | ç®¡ç†å“¡/æœƒè¨ˆ/æ¥­å‹™ |
| ğŸ”— é›»å­ç™¼ç¥¨ä¸²æ¥ (Payuni) | âŒ | âœ… | âœ… |
| ğŸ§¾ ç‡Ÿæ¥­ç¨… 401 ç”³å ± | âŒ | âœ… | âœ… |
| ğŸ’° ç‡Ÿæ‰€ç¨…è¨ˆç®—ï¼ˆæ“´å¤§æ›¸å¯©ï¼‰ | âŒ | âŒ | âœ… |
| ğŸ’¾ è³‡æ–™ä¿å­˜æœŸé™ | 1 å¹´ | 3 å¹´ | æ°¸ä¹… |

### 2.3 æˆæœ¬èˆ‡åˆ©æ½¤åˆ†æ

| é …ç›® | é‡‘é¡ |
|------|-----:|
| Supabase (Free Tier) | NT$0 |
| Cloudflare Pages (Free) | NT$0 |
| Resend (3,000å°/æœˆå…è²») | NT$0 |
| ç¶²åŸŸ (quote24.cc) | ~NT$500/å¹´ |
| **æ¯æœˆå›ºå®šæˆæœ¬** | **~NT$50** |
| Entry åˆ©æ½¤ | NT$199 - åˆ†æ”¤æˆæœ¬ â‰ˆ NT$180+ |
| Standard åˆ©æ½¤ | NT$899 - åˆ†æ”¤æˆæœ¬ â‰ˆ NT$850+ |
| Pro åˆ©æ½¤ | NT$2,499 - åˆ†æ”¤æˆæœ¬ â‰ˆ NT$2,400+ |
| **æç›Šå¹³è¡¡é»** | **1 å€‹ Entry å®¢æˆ¶å³å¯** |

### 2.4 Email æˆæœ¬ä¼°ç®—

| éšæ®µ | å®¢æˆ¶æ•¸ | é ä¼°æœˆç™¼é€é‡ | Resend è²»ç”¨ |
|------|-------:|------------:|------------:|
| åˆæœŸ | 1-50 | ~500 å° | NT$0ï¼ˆå…è²»é¡åº¦å…§ï¼‰ |
| æˆé•·æœŸ | 50-200 | ~3,000 å° | NT$0ï¼ˆå…è²»é¡åº¦å…§ï¼‰ |
| è¦æ¨¡æœŸ | 200+ | 3,000+ å° | ~NT$600/æœˆèµ· |

### 2.5 é‡‘æµèˆ‡è¯ç›Ÿè¡ŒéŠ·

> é‡‘æµä¸²æ¥èˆ‡è¯ç›Ÿè¡ŒéŠ·åˆ†æ½¤ç³»çµ±åƒè€ƒ **affiliate å°ˆæ¡ˆ**ï¼Œä¸åœ¨æœ¬ SDD ç¯„åœå…§ã€‚

---

## 3. æŠ€è¡“æ¶æ§‹

### 3.1 æ¶æ§‹åœ–

```mermaid
graph TB
    subgraph Client[å®¢æˆ¶ç«¯]
        BROWSER[ç€è¦½å™¨<br/>Chrome / Safari / Edge]
    end
    
    subgraph Cloudflare[Cloudflare]
        PAGES[Cloudflare Pages<br/>Next.js å…¨åŠŸèƒ½ç¶²ç«™]
        WORKERS[Cloudflare Workers<br/>æ’ç¨‹ä»»å‹™]
    end
    
    subgraph Supabase[Supabase]
        AUTH[Authentication<br/>ç”¨æˆ¶èªè­‰]
        DB[(PostgreSQL<br/>è³‡æ–™åº«)]
        STORAGE[Storage<br/>æª”æ¡ˆå„²å­˜]
        EDGE[Edge Functions<br/>ä¼ºæœå™¨é‚è¼¯]
        REALTIME[Realtime<br/>å³æ™‚è¨‚é–±]
    end
    
    subgraph External[å¤–éƒ¨æœå‹™]
        RESEND[Resend<br/>Email ç™¼é€]
        PAYUNI[Payuni<br/>é›»å­ç™¼ç¥¨]
    end
    
    BROWSER --> PAGES
    PAGES --> AUTH
    PAGES --> DB
    PAGES --> STORAGE
    PAGES --> REALTIME
    WORKERS --> EDGE
    EDGE --> RESEND
    EDGE --> PAYUNI
    EDGE --> DB
```

### 3.2 æŠ€è¡“è¦æ ¼

| å±¤ç´š | æŠ€è¡“ | ç‰ˆæœ¬/è¦æ ¼ | èªªæ˜ |
|------|------|----------|------|
| **å‰ç«¯æ¡†æ¶** | Next.js | 14+ (App Router) | React å…¨ç«¯æ¡†æ¶ |
| **UI å…ƒä»¶åº«** | shadcn/ui | - | åŸºæ–¼ Radix UI + Tailwind |
| **CSS æ¡†æ¶** | Tailwind CSS | 3.x | åŸå­åŒ– CSS |
| **éƒ¨ç½²å¹³å°** | Cloudflare Pages | - | å…¨çƒ CDN + Edge Runtime |
| **æ’ç¨‹ä»»å‹™** | Cloudflare Workers | Cron Triggers | å®šæ™‚æª¢æŸ¥åˆ°æœŸé€šçŸ¥ |
| **å¾Œç«¯æœå‹™** | Supabase | - | BaaS å¹³å° |
| **è³‡æ–™åº«** | PostgreSQL | 15+ | Supabase è¨—ç®¡ |
| **èªè­‰** | Supabase Auth | - | JWT + Row Level Security |
| **æª”æ¡ˆå„²å­˜** | Supabase Storage | - | S3 ç›¸å®¹ |
| **Email æœå‹™** | Resend | - | 3,000 å°/æœˆå…è²» |
| **ç‹€æ…‹ç®¡ç†** | Zustand / React Query | - | å®¢æˆ¶ç«¯ç‹€æ…‹ç®¡ç† |

### 3.3 å°ˆæ¡ˆçµæ§‹

```
/quote24/
â”œâ”€â”€ app/                           # Next.js App Router
â”‚   â”œâ”€â”€ (marketing)/              # è¡ŒéŠ·é é¢ç¾¤çµ„
â”‚   â”‚   â”œâ”€â”€ page.tsx              # é¦–é ï¼ˆç”¢å“ä»‹ç´¹ï¼‰
â”‚   â”‚   â”œâ”€â”€ pricing/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx          # å®šåƒ¹é é¢
â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx          # åŠŸèƒ½ä»‹ç´¹
â”‚   â”‚   â””â”€â”€ blog/
â”‚   â”‚       â”œâ”€â”€ page.tsx          # éƒ¨è½æ ¼åˆ—è¡¨
â”‚   â”‚       â””â”€â”€ [slug]/
â”‚   â”‚           â””â”€â”€ page.tsx      # æ–‡ç« å…§å®¹
â”‚   â”œâ”€â”€ (auth)/                   # èªè­‰é é¢ç¾¤çµ„
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx          # ç™»å…¥
â”‚   â”‚   â”œâ”€â”€ register/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx          # è¨»å†Š
â”‚   â”‚   â””â”€â”€ forgot-password/
â”‚   â”‚       â””â”€â”€ page.tsx          # å¿˜è¨˜å¯†ç¢¼
â”‚   â”œâ”€â”€ (dashboard)/              # æ‡‰ç”¨ç¨‹å¼ä¸»é«”ï¼ˆéœ€ç™»å…¥ï¼‰
â”‚   â”‚   â”œâ”€â”€ layout.tsx            # Dashboard å…±ç”¨ Layout
â”‚   â”‚   â”œâ”€â”€ page.tsx              # å„€è¡¨æ¿é¦–é 
â”‚   â”‚   â”œâ”€â”€ contacts/
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx          # å®¢æˆ¶/å» å•†åˆ—è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ new/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx      # æ–°å¢
â”‚   â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx      # ç·¨è¼¯/è©³æƒ…
â”‚   â”‚   â”œâ”€â”€ products/
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx          # å•†å“åˆ—è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ new/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ quotes/
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx          # å ±åƒ¹å–®åˆ—è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ new/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ orders/
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx          # è¨‚å–®åˆ—è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ new/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ shipments/
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx          # å‡ºè²¨å–®åˆ—è¡¨
â”‚   â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ invoices/
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx          # ç™¼ç¥¨åˆ—è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ new/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ reports/
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx          # å ±è¡¨ç¸½è¦½
â”‚   â”‚   â”‚   â”œâ”€â”€ income-statement/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx      # æç›Šè¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ balance-sheet/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx      # è³‡ç”¢è² å‚µè¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ cash-flow/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx      # ç¾é‡‘æµé‡è¡¨
â”‚   â”‚   â”‚   â””â”€â”€ aging/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx      # å¸³é½¡åˆ†æ
â”‚   â”‚   â”œâ”€â”€ tax/
â”‚   â”‚   â”‚   â”œâ”€â”€ vat/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx      # ç‡Ÿæ¥­ç¨… 401
â”‚   â”‚   â”‚   â””â”€â”€ income-tax/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx      # ç‡Ÿæ‰€ç¨…
â”‚   â”‚   â”œâ”€â”€ notifications/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx          # é€šçŸ¥ä¸­å¿ƒ
â”‚   â”‚   â””â”€â”€ settings/
â”‚   â”‚       â”œâ”€â”€ page.tsx          # è¨­å®šç¸½è¦½
â”‚   â”‚       â”œâ”€â”€ company/
â”‚   â”‚       â”‚   â””â”€â”€ page.tsx      # å…¬å¸è³‡æ–™
â”‚   â”‚       â”œâ”€â”€ users/
â”‚   â”‚       â”‚   â””â”€â”€ page.tsx      # ä½¿ç”¨è€…ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ notifications/
â”‚   â”‚       â”‚   â””â”€â”€ page.tsx      # é€šçŸ¥è¨­å®š
â”‚   â”‚       â”œâ”€â”€ invoice/
â”‚   â”‚       â”‚   â””â”€â”€ page.tsx      # é›»å­ç™¼ç¥¨è¨­å®š
â”‚   â”‚       â””â”€â”€ subscription/
â”‚   â”‚           â””â”€â”€ page.tsx      # è¨‚é–±ç®¡ç†
â”‚   â”œâ”€â”€ api/                      # API Routes
â”‚   â”‚   â”œâ”€â”€ webhooks/
â”‚   â”‚   â”‚   â””â”€â”€ payuni/
â”‚   â”‚   â”‚       â””â”€â”€ route.ts      # Payuni Webhook
â”‚   â”‚   â””â”€â”€ cron/
â”‚   â”‚       â””â”€â”€ check-due/
â”‚   â”‚           â””â”€â”€ route.ts      # åˆ°æœŸæª¢æŸ¥ï¼ˆä¾› CF Workers å‘¼å«ï¼‰
â”‚   â”œâ”€â”€ layout.tsx                # æ ¹ Layout
â”‚   â””â”€â”€ globals.css               # å…¨åŸŸæ¨£å¼
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ui/                       # shadcn/ui å…ƒä»¶
â”‚   â”œâ”€â”€ layout/
â”‚   â”‚   â”œâ”€â”€ header.tsx
â”‚   â”‚   â”œâ”€â”€ sidebar.tsx
â”‚   â”‚   â”œâ”€â”€ notification-bell.tsx # é€šçŸ¥éˆ´éº
â”‚   â”‚   â””â”€â”€ footer.tsx
â”‚   â”œâ”€â”€ forms/
â”‚   â”‚   â”œâ”€â”€ contact-form.tsx
â”‚   â”‚   â”œâ”€â”€ product-form.tsx
â”‚   â”‚   â”œâ”€â”€ quote-form.tsx
â”‚   â”‚   â”œâ”€â”€ order-form.tsx
â”‚   â”‚   â””â”€â”€ invoice-form.tsx
â”‚   â”œâ”€â”€ tables/
â”‚   â”‚   â”œâ”€â”€ contacts-table.tsx
â”‚   â”‚   â”œâ”€â”€ quotes-table.tsx
â”‚   â”‚   â””â”€â”€ data-table.tsx        # é€šç”¨è³‡æ–™è¡¨æ ¼
â”‚   â””â”€â”€ charts/
â”‚       â”œâ”€â”€ revenue-chart.tsx
â”‚       â””â”€â”€ aging-chart.tsx
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ supabase/
â”‚   â”‚   â”œâ”€â”€ client.ts             # ç€è¦½å™¨ç«¯ Client
â”‚   â”‚   â”œâ”€â”€ server.ts             # ä¼ºæœå™¨ç«¯ Client
â”‚   â”‚   â””â”€â”€ middleware.ts         # Auth Middleware
â”‚   â”œâ”€â”€ resend/
â”‚   â”‚   â””â”€â”€ client.ts             # Resend Client
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ formatters.ts         # æ ¼å¼åŒ–å·¥å…·
â”‚   â”‚   â”œâ”€â”€ validators.ts         # é©—è­‰å·¥å…·
â”‚   â”‚   â””â”€â”€ tax-calculator.ts     # ç¨…é¡è¨ˆç®—
â”‚   â””â”€â”€ constants/
â”‚       â”œâ”€â”€ notification-types.ts
â”‚       â””â”€â”€ industry-codes.ts     # è¡Œæ¥­ä»£ç¢¼èˆ‡ç´”ç›Šç‡
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ use-notifications.ts      # é€šçŸ¥ç›¸é—œ Hook
â”‚   â”œâ”€â”€ use-realtime.ts           # Supabase Realtime Hook
â”‚   â””â”€â”€ use-auth.ts               # èªè­‰ç›¸é—œ Hook
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ database.ts               # Supabase è‡ªå‹•ç”¢ç”Ÿçš„å‹åˆ¥
â”‚   â”œâ”€â”€ contact.ts
â”‚   â”œâ”€â”€ quote.ts
â”‚   â”œâ”€â”€ order.ts
â”‚   â””â”€â”€ notification.ts
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ migrations/               # è³‡æ–™åº«é·ç§»
â”‚   â”œâ”€â”€ functions/                # Edge Functions
â”‚   â”‚   â”œâ”€â”€ send-email/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ check-due-payments/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ issue-invoice/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ generate-vat-report/
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â””â”€â”€ seed.sql                  # ç¨®å­è³‡æ–™
â”œâ”€â”€ workers/                      # Cloudflare Workers
â”‚   â””â”€â”€ cron-trigger/
â”‚       â”œâ”€â”€ index.ts              # æ’ç¨‹è§¸ç™¼å™¨
â”‚       â””â”€â”€ wrangler.toml
â”œâ”€â”€ public/
â”‚   â””â”€â”€ images/
â”œâ”€â”€ package.json
â”œâ”€â”€ tailwind.config.ts
â”œâ”€â”€ tsconfig.json
â””â”€â”€ README.md
```

### 3.4 é–‹ç™¼è¦ç¯„

#### 3.4.1 å‘½åè¦ç¯„

| é¡å‹ | è¦ç¯„ | ç¯„ä¾‹ |
|------|------|------|
| æª”æ¡ˆåç¨± | kebab-case | `contact-form.tsx`, `use-notifications.ts` |
| React å…ƒä»¶ | PascalCase | `ContactForm`, `NotificationBell` |
| å‡½å¼/è®Šæ•¸ | camelCase | `calculateTotal()`, `contactList` |
| å¸¸æ•¸ | UPPER_SNAKE_CASE | `VAT_RATE`, `NOTIFICATION_TYPES` |
| è³‡æ–™è¡¨ | snake_case | `contacts`, `quote_items` |
| è³‡æ–™è¡¨æ¬„ä½ | snake_case | `contact_type`, `created_at` |

#### 3.4.2 TypeScript å‹åˆ¥ç¯„ä¾‹

```typescript
// types/contact.ts

export type ContactType = 'CUSTOMER' | 'VENDOR' | 'BOTH';

export interface Contact {
  id: string;
  organization_id: string;
  contact_type: ContactType;
  company_name: string;
  tax_id?: string;
  contact_person?: string;
  phone?: string;
  email?: string;
  address?: string;
  payment_terms: number;
  notes?: string;
  created_at: string;
  updated_at: string;
}

export interface ContactFormData {
  contact_type: ContactType;
  company_name: string;
  tax_id?: string;
  contact_person?: string;
  phone?: string;
  email?: string;
  address?: string;
  payment_terms?: number;
  notes?: string;
}

// types/notification.ts

export type NotificationType = 
  | 'PAYMENT_DUE'
  | 'PAYMENT_OVERDUE'
  | 'QUOTE_EXPIRING'
  | 'QUOTE_ACCEPTED'
  | 'ORDER_CONFIRMED'
  | 'PAYMENT_RECEIVED'
  | 'SYSTEM';

export interface Notification {
  id: string;
  organization_id: string;
  user_id: string;
  type: NotificationType;
  title: string;
  message: string;
  reference_type?: 'INVOICE' | 'QUOTE' | 'ORDER';
  reference_id?: string;
  is_read: boolean;
  is_emailed: boolean;
  created_at: string;
}

export interface NotificationSettings {
  id: string;
  organization_id: string;
  email_recipients: string[];  // å¯å¤šå€‹ Email
  enabled_types: NotificationType[];  // å•Ÿç”¨çš„é€šçŸ¥é¡å‹
  payment_due_days: number;  // åˆ°æœŸå‰å¹¾å¤©æé†’
  payment_overdue_enabled: boolean;  // é€¾æœŸæ˜¯å¦æé†’
  quote_expiring_days: number;  // å ±åƒ¹å–®åˆ°æœŸå‰å¹¾å¤©æé†’
  email_enabled: boolean;  // æ˜¯å¦é–‹å•Ÿ Email é€šçŸ¥
  created_at: string;
  updated_at: string;
}
```

---

## 4. è³‡æ–™åº«è¨­è¨ˆ

### 4.1 å¯¦é«”é—œä¿‚åœ– (ERD)

```mermaid
erDiagram
    ORGANIZATIONS ||--o{ USERS : "has"
    ORGANIZATIONS ||--o{ CONTACTS : "has"
    ORGANIZATIONS ||--o{ PRODUCTS : "has"
    ORGANIZATIONS ||--o{ QUOTES : "has"
    ORGANIZATIONS ||--o{ ORDERS : "has"
    ORGANIZATIONS ||--o{ INVOICES : "has"
    ORGANIZATIONS ||--o{ NOTIFICATIONS : "has"
    ORGANIZATIONS ||--|| NOTIFICATION_SETTINGS : "has"
    
    USERS ||--o{ QUOTES : "creates"
    USERS ||--o{ ORDERS : "creates"
    USERS ||--o{ NOTIFICATIONS : "receives"
    
    CONTACTS ||--o{ QUOTES : "receives"
    CONTACTS ||--o{ ORDERS : "places"
    CONTACTS ||--o{ INVOICES : "billed_to"
    
    QUOTES ||--o{ QUOTE_ITEMS : "contains"
    QUOTES ||--o| ORDERS : "converts_to"
    
    ORDERS ||--o{ ORDER_ITEMS : "contains"
    ORDERS ||--o| SHIPMENTS : "ships_via"
    ORDERS ||--o| INVOICES : "bills_via"
    
    SHIPMENTS ||--o{ SHIPMENT_ITEMS : "contains"
    
    INVOICES ||--o{ INVOICE_ITEMS : "contains"
    INVOICES ||--o{ PAYMENTS : "receives"
    
    PRODUCTS ||--o{ QUOTE_ITEMS : "in"
    PRODUCTS ||--o{ ORDER_ITEMS : "in"
    PRODUCTS ||--o{ INVENTORY_TRANSACTIONS : "tracks"
    
    VAT_REPORTS ||--o{ VAT_REPORT_ITEMS : "contains"
    
    ORGANIZATIONS {
        uuid id PK
        string name "å…¬å¸åç¨±"
        string tax_id "çµ±ä¸€ç·¨è™Ÿ"
        string plan "ENTRY | STANDARD | PRO"
        date plan_expires_at "æ–¹æ¡ˆåˆ°æœŸæ—¥"
        jsonb settings "ç³»çµ±è¨­å®š"
        timestamp created_at
    }
    
    USERS {
        uuid id PK
        uuid organization_id FK
        string email "Email"
        string name "å§“å"
        string role "ADMIN | ACCOUNTANT | SALES"
        boolean is_active
        timestamp created_at
    }
    
    NOTIFICATION_SETTINGS {
        uuid id PK
        uuid organization_id FK
        text[] email_recipients "æ¥æ”¶ Email åˆ—è¡¨"
        text[] enabled_types "å•Ÿç”¨çš„é€šçŸ¥é¡å‹"
        int payment_due_days "åˆ°æœŸå‰æé†’å¤©æ•¸"
        boolean payment_overdue_enabled "é€¾æœŸæé†’"
        int quote_expiring_days "å ±åƒ¹åˆ°æœŸå‰æé†’å¤©æ•¸"
        boolean email_enabled "Email é€šçŸ¥é–‹é—œ"
        timestamp created_at
        timestamp updated_at
    }
    
    NOTIFICATIONS {
        uuid id PK
        uuid organization_id FK
        uuid user_id FK
        string type "é€šçŸ¥é¡å‹"
        string title "æ¨™é¡Œ"
        text message "å…§å®¹"
        string reference_type "é—œè¯é¡å‹"
        uuid reference_id "é—œè¯ ID"
        boolean is_read "å·²è®€"
        boolean is_emailed "å·²ç™¼é€ Email"
        timestamp created_at
    }
    
    CONTACTS {
        uuid id PK
        uuid organization_id FK
        string contact_type "CUSTOMER | VENDOR | BOTH"
        string company_name "å…¬å¸åç¨±"
        string tax_id "çµ±ä¸€ç·¨è™Ÿ"
        string contact_person "è¯çµ¡äºº"
        string phone "é›»è©±"
        string email "Email"
        string address "åœ°å€"
        int payment_terms "ä»˜æ¬¾å¤©æ•¸"
        text notes "å‚™è¨»"
        timestamp created_at
        timestamp updated_at
    }
    
    PRODUCTS {
        uuid id PK
        uuid organization_id FK
        string sku "å•†å“ç·¨è™Ÿ"
        string name "å•†å“åç¨±"
        text description "æè¿°"
        decimal unit_price "å–®åƒ¹"
        decimal cost "æˆæœ¬"
        string unit "å–®ä½"
        int stock_quantity "åº«å­˜æ•¸é‡"
        boolean is_active
        boolean track_inventory "è¿½è¹¤åº«å­˜"
        timestamp created_at
        timestamp updated_at
    }
    
    QUOTES {
        uuid id PK
        uuid organization_id FK
        uuid contact_id FK
        uuid created_by FK
        string quote_number "å ±åƒ¹å–®è™Ÿ"
        date quote_date "å ±åƒ¹æ—¥æœŸ"
        date valid_until "æœ‰æ•ˆæœŸé™"
        string status "DRAFT | SENT | ACCEPTED | REJECTED | EXPIRED"
        decimal subtotal "å°è¨ˆ"
        decimal tax_amount "ç¨…é¡"
        decimal total_amount "ç¸½è¨ˆ"
        text notes "å‚™è¨»"
        text terms "æ¢æ¬¾"
        timestamp created_at
        timestamp updated_at
    }
    
    INVOICES {
        uuid id PK
        uuid organization_id FK
        uuid contact_id FK
        uuid order_id FK
        string invoice_number "ç™¼ç¥¨è™Ÿç¢¼"
        string invoice_type "B2B | B2C"
        date invoice_date "ç™¼ç¥¨æ—¥æœŸ"
        date due_date "ä»˜æ¬¾æœŸé™"
        string status "DRAFT | ISSUED | PAID | OVERDUE | CANCELLED"
        decimal subtotal "å°è¨ˆ"
        decimal tax_amount "ç¨…é¡"
        decimal total_amount "ç¸½è¨ˆ"
        decimal paid_amount "å·²ä»˜é‡‘é¡"
        string payuni_invoice_no "Payuni ç™¼ç¥¨è™Ÿç¢¼"
        text notes "å‚™è¨»"
        timestamp created_at
        timestamp updated_at
    }
```

### 4.2 è³‡æ–™è¡¨è©³ç´°è¦æ ¼

#### 4.2.1 `organizations` - çµ„ç¹”/å…¬å¸è¡¨

| æ¬„ä½åç¨± | è³‡æ–™å‹æ…‹ | ç´„æŸ | èªªæ˜ |
|---------|---------|------|------|
| `id` | UUID | PK, DEFAULT uuid_generate_v4() | ä¸»éµ |
| `name` | VARCHAR(100) | NOT NULL | å…¬å¸åç¨± |
| `tax_id` | VARCHAR(8) | UNIQUE | çµ±ä¸€ç·¨è™Ÿ |
| `plan` | VARCHAR(20) | NOT NULL, DEFAULT 'ENTRY' | è¨‚é–±æ–¹æ¡ˆ |
| `plan_expires_at` | DATE | NULL | æ–¹æ¡ˆåˆ°æœŸæ—¥ |
| `settings` | JSONB | DEFAULT '{}' | ç³»çµ±è¨­å®š |
| `created_at` | TIMESTAMPTZ | NOT NULL, DEFAULT NOW() | å»ºç«‹æ™‚é–“ |
| `updated_at` | TIMESTAMPTZ | NOT NULL, DEFAULT NOW() | æ›´æ–°æ™‚é–“ |

#### 4.2.2 `users` - ä½¿ç”¨è€…è¡¨

| æ¬„ä½åç¨± | è³‡æ–™å‹æ…‹ | ç´„æŸ | èªªæ˜ |
|---------|---------|------|------|
| `id` | UUID | PK, FK â†’ auth.users.id | ä¸»éµ (å°æ‡‰ Supabase Auth) |
| `organization_id` | UUID | FK â†’ organizations.id | æ‰€å±¬çµ„ç¹” |
| `email` | VARCHAR(255) | NOT NULL | Email |
| `name` | VARCHAR(100) | NOT NULL | å§“å |
| `role` | VARCHAR(20) | NOT NULL, DEFAULT 'ADMIN' | è§’è‰²ï¼šADMIN/ACCOUNTANT/SALES |
| `is_active` | BOOLEAN | NOT NULL, DEFAULT TRUE | æ˜¯å¦å•Ÿç”¨ |
| `created_at` | TIMESTAMPTZ | NOT NULL, DEFAULT NOW() | å»ºç«‹æ™‚é–“ |
| `updated_at` | TIMESTAMPTZ | NOT NULL, DEFAULT NOW() | æ›´æ–°æ™‚é–“ |

#### 4.2.3 `notification_settings` - é€šçŸ¥è¨­å®šè¡¨

| æ¬„ä½åç¨± | è³‡æ–™å‹æ…‹ | ç´„æŸ | èªªæ˜ |
|---------|---------|------|------|
| `id` | UUID | PK, DEFAULT uuid_generate_v4() | ä¸»éµ |
| `organization_id` | UUID | FK â†’ organizations.id, UNIQUE | æ‰€å±¬çµ„ç¹”ï¼ˆä¸€å°ä¸€ï¼‰ |
| `email_recipients` | TEXT[] | NOT NULL, DEFAULT '{}' | æ¥æ”¶é€šçŸ¥çš„ Email åˆ—è¡¨ |
| `enabled_types` | TEXT[] | NOT NULL, DEFAULT '{PAYMENT_DUE,PAYMENT_OVERDUE,QUOTE_EXPIRING}' | å•Ÿç”¨çš„é€šçŸ¥é¡å‹ |
| `payment_due_days` | INT | NOT NULL, DEFAULT 3 | æ¬¾é …åˆ°æœŸå‰å¹¾å¤©æé†’ |
| `payment_overdue_enabled` | BOOLEAN | NOT NULL, DEFAULT TRUE | æ˜¯å¦æé†’é€¾æœŸæ¬¾é … |
| `quote_expiring_days` | INT | NOT NULL, DEFAULT 3 | å ±åƒ¹å–®åˆ°æœŸå‰å¹¾å¤©æé†’ |
| `email_enabled` | BOOLEAN | NOT NULL, DEFAULT TRUE | æ˜¯å¦é–‹å•Ÿ Email é€šçŸ¥ |
| `created_at` | TIMESTAMPTZ | NOT NULL, DEFAULT NOW() | å»ºç«‹æ™‚é–“ |
| `updated_at` | TIMESTAMPTZ | NOT NULL, DEFAULT NOW() | æ›´æ–°æ™‚é–“ |

#### 4.2.4 `notifications` - é€šçŸ¥è¨˜éŒ„è¡¨

| æ¬„ä½åç¨± | è³‡æ–™å‹æ…‹ | ç´„æŸ | èªªæ˜ |
|---------|---------|------|------|
| `id` | UUID | PK, DEFAULT uuid_generate_v4() | ä¸»éµ |
| `organization_id` | UUID | FK â†’ organizations.id, NOT NULL | æ‰€å±¬çµ„ç¹” |
| `user_id` | UUID | FK â†’ users.id, NULL | æ¥æ”¶è€…ï¼ˆNULL è¡¨ç¤ºå…¨çµ„ç¹”ï¼‰ |
| `type` | VARCHAR(30) | NOT NULL | é¡å‹ |
| `title` | VARCHAR(100) | NOT NULL | æ¨™é¡Œ |
| `message` | TEXT | NOT NULL | å…§å®¹ |
| `reference_type` | VARCHAR(20) | NULL | é—œè¯é¡å‹ï¼šINVOICE/QUOTE/ORDER |
| `reference_id` | UUID | NULL | é—œè¯ ID |
| `is_read` | BOOLEAN | NOT NULL, DEFAULT FALSE | å·²è®€ |
| `is_emailed` | BOOLEAN | NOT NULL, DEFAULT FALSE | å·²ç™¼é€ Email |
| `created_at` | TIMESTAMPTZ | NOT NULL, DEFAULT NOW() | å»ºç«‹æ™‚é–“ |

**é€šçŸ¥é¡å‹ (type)**:
- `PAYMENT_DUE` - æ¬¾é …å³å°‡åˆ°æœŸ
- `PAYMENT_OVERDUE` - æ¬¾é …å·²é€¾æœŸ
- `QUOTE_EXPIRING` - å ±åƒ¹å–®å³å°‡åˆ°æœŸ
- `QUOTE_ACCEPTED` - å ±åƒ¹å–®å·²è¢«æ¥å—
- `ORDER_CONFIRMED` - è¨‚å–®å·²ç¢ºèª
- `PAYMENT_RECEIVED` - å·²æ”¶åˆ°ä»˜æ¬¾
- `SYSTEM` - ç³»çµ±é€šçŸ¥

### 4.3 è³‡æ–™åº« Migration SQL

```sql
-- migrations/001_create_notification_settings.sql

-- å»ºç«‹é€šçŸ¥è¨­å®šè¡¨
CREATE TABLE notification_settings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL UNIQUE REFERENCES organizations(id) ON DELETE CASCADE,
  email_recipients TEXT[] NOT NULL DEFAULT '{}',
  enabled_types TEXT[] NOT NULL DEFAULT '{PAYMENT_DUE,PAYMENT_OVERDUE,QUOTE_EXPIRING}',
  payment_due_days INT NOT NULL DEFAULT 3,
  payment_overdue_enabled BOOLEAN NOT NULL DEFAULT TRUE,
  quote_expiring_days INT NOT NULL DEFAULT 3,
  email_enabled BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- å»ºç«‹ç´¢å¼•
CREATE INDEX idx_notification_settings_org ON notification_settings(organization_id);

-- RLS æ”¿ç­–
ALTER TABLE notification_settings ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own org notification settings"
  ON notification_settings FOR SELECT
  USING (organization_id = auth.jwt()->>'organization_id');

CREATE POLICY "Admins can update own org notification settings"
  ON notification_settings FOR UPDATE
  USING (organization_id = auth.jwt()->>'organization_id')
  WITH CHECK (organization_id = auth.jwt()->>'organization_id');

-- è‡ªå‹•å»ºç«‹é€šçŸ¥è¨­å®šï¼ˆç•¶çµ„ç¹”å»ºç«‹æ™‚ï¼‰
CREATE OR REPLACE FUNCTION create_notification_settings()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO notification_settings (organization_id, email_recipients)
  VALUES (NEW.id, ARRAY[(SELECT email FROM users WHERE organization_id = NEW.id LIMIT 1)]);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER on_organization_created
  AFTER INSERT ON organizations
  FOR EACH ROW
  EXECUTE FUNCTION create_notification_settings();


-- migrations/002_create_notifications.sql

-- å»ºç«‹é€šçŸ¥è¨˜éŒ„è¡¨
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  type VARCHAR(30) NOT NULL,
  title VARCHAR(100) NOT NULL,
  message TEXT NOT NULL,
  reference_type VARCHAR(20),
  reference_id UUID,
  is_read BOOLEAN NOT NULL DEFAULT FALSE,
  is_emailed BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- å»ºç«‹ç´¢å¼•
CREATE INDEX idx_notifications_org ON notifications(organization_id);
CREATE INDEX idx_notifications_user ON notifications(user_id);
CREATE INDEX idx_notifications_unread ON notifications(organization_id, is_read) WHERE is_read = FALSE;
CREATE INDEX idx_notifications_created ON notifications(created_at DESC);

-- RLS æ”¿ç­–
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own org notifications"
  ON notifications FOR SELECT
  USING (organization_id = auth.jwt()->>'organization_id');

CREATE POLICY "Users can update own notifications"
  ON notifications FOR UPDATE
  USING (organization_id = auth.jwt()->>'organization_id');
```

---

## 5. API è¨­è¨ˆè¦æ ¼

### 5.1 API ç¸½è¦½

> Next.js ä½¿ç”¨ Server Actions èˆ‡ Route Handlers è™•ç† API é‚è¼¯ï¼Œå¤§éƒ¨åˆ† CRUD ç›´æ¥é€é Supabase Client SDKã€‚
> ä»¥ä¸‹åˆ—å‡ºéœ€è¦ç‰¹åˆ¥è™•ç†çš„ APIã€‚

| æ¨¡çµ„ | é¡å‹ | è·¯å¾‘/å‡½å¼ | èªªæ˜ |
|------|------|----------|------|
| **é€šçŸ¥** ||||
| | Route Handler | `POST /api/cron/check-due` | æª¢æŸ¥åˆ°æœŸæ¬¾é …ï¼ˆæ’ç¨‹ç”¨ï¼‰ |
| | Server Action | `markNotificationRead()` | æ¨™è¨˜é€šçŸ¥å·²è®€ |
| | Server Action | `markAllNotificationsRead()` | æ¨™è¨˜å…¨éƒ¨å·²è®€ |
| **å ±åƒ¹å–®** ||||
| | Server Action | `convertQuoteToOrder()` | å ±åƒ¹å–®è½‰è¨‚å–® |
| | Server Action | `sendQuoteEmail()` | ç™¼é€å ±åƒ¹å–® Email |
| **ç™¼ç¥¨** ||||
| | Edge Function | `issue-invoice` | é–‹ç«‹é›»å­ç™¼ç¥¨ (Payuni) |
| | Edge Function | `void-invoice` | ä½œå»¢ç™¼ç¥¨ |
| | Route Handler | `POST /api/webhooks/payuni` | Payuni å›èª¿ |
| **ç¨…å‹™ç”³å ±** ||||
| | Server Action | `generateVatReport()` | ç”¢ç”Ÿ 401 ç”³å ±æª” |
| | Server Action | `calculateIncomeTax()` | ç‡Ÿæ‰€ç¨…è©¦ç®— |
| **Email** ||||
| | Edge Function | `send-notification-email` | ç™¼é€é€šçŸ¥ Email |

### 5.2 é€šçŸ¥æ’ç¨‹æª¢æŸ¥ API

```typescript
// app/api/cron/check-due/route.ts

import { createClient } from '@/lib/supabase/server';
import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

export async function POST(request: Request) {
  // é©—è­‰ Cloudflare Workers çš„è«‹æ±‚
  const authHeader = request.headers.get('Authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const supabase = createClient();
  const today = new Date().toISOString().split('T')[0];
  
  // å–å¾—æ‰€æœ‰çµ„ç¹”çš„é€šçŸ¥è¨­å®š
  const { data: allSettings } = await supabase
    .from('notification_settings')
    .select('*, organization:organizations(id, name)')
    .eq('email_enabled', true);

  const results = {
    processed: 0,
    notifications_created: 0,
    emails_sent: 0,
  };

  for (const settings of allSettings || []) {
    // è¨ˆç®—æé†’æ—¥æœŸ
    const dueDateThreshold = new Date(
      Date.now() + settings.payment_due_days * 24 * 60 * 60 * 1000
    ).toISOString().split('T')[0];

    // æª¢æŸ¥è©²çµ„ç¹”æ˜¯å¦æœ‰å•Ÿç”¨ PAYMENT_DUE é€šçŸ¥
    if (settings.enabled_types.includes('PAYMENT_DUE')) {
      // æŸ¥è©¢å³å°‡åˆ°æœŸçš„ç™¼ç¥¨
      const { data: dueSoon } = await supabase
        .from('invoices')
        .select(`
          id, invoice_number, total_amount, due_date,
          contact:contacts(company_name)
        `)
        .eq('organization_id', settings.organization_id)
        .eq('status', 'ISSUED')
        .gte('due_date', today)
        .lte('due_date', dueDateThreshold);

      for (const invoice of dueSoon || []) {
        const daysUntilDue = Math.ceil(
          (new Date(invoice.due_date).getTime() - Date.now()) / (1000 * 60 * 60 * 24)
        );

        // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒé€šçŸ¥ï¼ˆé¿å…é‡è¤‡ï¼‰
        const { data: existing } = await supabase
          .from('notifications')
          .select('id')
          .eq('reference_type', 'INVOICE')
          .eq('reference_id', invoice.id)
          .eq('type', 'PAYMENT_DUE')
          .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString())
          .single();

        if (!existing) {
          // å»ºç«‹é€šçŸ¥
          const notification = {
            organization_id: settings.organization_id,
            type: 'PAYMENT_DUE',
            title: 'æ¬¾é …å³å°‡åˆ°æœŸ',
            message: `${invoice.contact.company_name} çš„ç™¼ç¥¨ ${invoice.invoice_number}ï¼ˆNT$${invoice.total_amount.toLocaleString()}ï¼‰å°‡æ–¼ ${daysUntilDue} å¤©å¾Œåˆ°æœŸ`,
            reference_type: 'INVOICE',
            reference_id: invoice.id,
          };

          await supabase.from('notifications').insert(notification);
          results.notifications_created++;

          // ç™¼é€ Email
          if (settings.email_recipients.length > 0) {
            await resend.emails.send({
              from: 'è¨˜å¸³é€š <noreply@quote24.cc>',
              to: settings.email_recipients,
              subject: `[è¨˜å¸³é€š] æ¬¾é …å³å°‡åˆ°æœŸï¼š${invoice.invoice_number}`,
              html: `
                <h2>æ¬¾é …å³å°‡åˆ°æœŸæé†’</h2>
                <p>æ‚¨æœ‰ä¸€ç­†æ¬¾é …å³å°‡åˆ°æœŸï¼š</p>
                <ul>
                  <li><strong>å®¢æˆ¶</strong>ï¼š${invoice.contact.company_name}</li>
                  <li><strong>ç™¼ç¥¨è™Ÿç¢¼</strong>ï¼š${invoice.invoice_number}</li>
                  <li><strong>é‡‘é¡</strong>ï¼šNT$${invoice.total_amount.toLocaleString()}</li>
                  <li><strong>åˆ°æœŸæ—¥</strong>ï¼š${invoice.due_date}ï¼ˆ${daysUntilDue} å¤©å¾Œï¼‰</li>
                </ul>
                <p><a href="https://quote24.cc/invoices/${invoice.id}">æŸ¥çœ‹ç™¼ç¥¨è©³æƒ…</a></p>
              `,
            });
            results.emails_sent++;

            // æ›´æ–°é€šçŸ¥ç‚ºå·²ç™¼é€ Email
            await supabase
              .from('notifications')
              .update({ is_emailed: true })
              .eq('reference_id', invoice.id)
              .eq('type', 'PAYMENT_DUE');
          }
        }
      }
    }

    // æª¢æŸ¥é€¾æœŸæ¬¾é …
    if (settings.payment_overdue_enabled && settings.enabled_types.includes('PAYMENT_OVERDUE')) {
      const { data: overdue } = await supabase
        .from('invoices')
        .select(`
          id, invoice_number, total_amount, due_date,
          contact:contacts(company_name)
        `)
        .eq('organization_id', settings.organization_id)
        .eq('status', 'ISSUED')
        .lt('due_date', today);

      for (const invoice of overdue || []) {
        // æ›´æ–°ç™¼ç¥¨ç‹€æ…‹ç‚ºé€¾æœŸ
        await supabase
          .from('invoices')
          .update({ status: 'OVERDUE' })
          .eq('id', invoice.id);

        const daysOverdue = Math.ceil(
          (Date.now() - new Date(invoice.due_date).getTime()) / (1000 * 60 * 60 * 24)
        );

        // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒé€šçŸ¥
        const { data: existing } = await supabase
          .from('notifications')
          .select('id')
          .eq('reference_type', 'INVOICE')
          .eq('reference_id', invoice.id)
          .eq('type', 'PAYMENT_OVERDUE')
          .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString())
          .single();

        if (!existing) {
          const notification = {
            organization_id: settings.organization_id,
            type: 'PAYMENT_OVERDUE',
            title: 'æ¬¾é …å·²é€¾æœŸ',
            message: `${invoice.contact.company_name} çš„ç™¼ç¥¨ ${invoice.invoice_number}ï¼ˆNT$${invoice.total_amount.toLocaleString()}ï¼‰å·²é€¾æœŸ ${daysOverdue} å¤©`,
            reference_type: 'INVOICE',
            reference_id: invoice.id,
          };

          await supabase.from('notifications').insert(notification);
          results.notifications_created++;

          if (settings.email_recipients.length > 0) {
            await resend.emails.send({
              from: 'è¨˜å¸³é€š <noreply@quote24.cc>',
              to: settings.email_recipients,
              subject: `[è¨˜å¸³é€š] âš ï¸ æ¬¾é …å·²é€¾æœŸï¼š${invoice.invoice_number}`,
              html: `
                <h2>âš ï¸ æ¬¾é …å·²é€¾æœŸ</h2>
                <p>æ‚¨æœ‰ä¸€ç­†æ¬¾é …å·²é€¾æœŸï¼š</p>
                <ul>
                  <li><strong>å®¢æˆ¶</strong>ï¼š${invoice.contact.company_name}</li>
                  <li><strong>ç™¼ç¥¨è™Ÿç¢¼</strong>ï¼š${invoice.invoice_number}</li>
                  <li><strong>é‡‘é¡</strong>ï¼šNT$${invoice.total_amount.toLocaleString()}</li>
                  <li><strong>åˆ°æœŸæ—¥</strong>ï¼š${invoice.due_date}</li>
                  <li><strong>é€¾æœŸå¤©æ•¸</strong>ï¼š${daysOverdue} å¤©</li>
                </ul>
                <p><a href="https://quote24.cc/invoices/${invoice.id}">æŸ¥çœ‹ç™¼ç¥¨è©³æƒ…</a></p>
              `,
            });
            results.emails_sent++;
          }
        }
      }
    }

    results.processed++;
  }

  return Response.json({ success: true, ...results });
}
```

### 5.3 Cloudflare Workers æ’ç¨‹è§¸ç™¼

```typescript
// workers/cron-trigger/index.ts

export default {
  async scheduled(event: ScheduledEvent, env: Env, ctx: ExecutionContext) {
    // æ¯å¤©æ—©ä¸Š 9:00 åŸ·è¡Œï¼ˆå°ç£æ™‚é–“ï¼‰
    const response = await fetch('https://quote24.cc/api/cron/check-due', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${env.CRON_SECRET}`,
        'Content-Type': 'application/json',
      },
    });

    const result = await response.json();
    console.log('Cron job result:', result);
  },
};

// workers/cron-trigger/wrangler.toml
// name = "quote24-cron"
// main = "index.ts"
// compatibility_date = "2024-01-01"
// 
// [triggers]
// crons = ["0 1 * * *"]  # UTC 01:00 = å°ç£ 09:00
```

---

## 6. é é¢åŠŸèƒ½è¦æ ¼

### 6.1 ç¶²ç«™é é¢çµæ§‹

```
ğŸŒ è¨˜å¸³é€š ç¶²ç«™
â”œâ”€â”€ ğŸ“¢ è¡ŒéŠ·é é¢ï¼ˆå…¬é–‹ï¼‰
â”‚   â”œâ”€â”€ é¦–é ï¼ˆç”¢å“ä»‹ç´¹ï¼‰
â”‚   â”œâ”€â”€ åŠŸèƒ½ä»‹ç´¹
â”‚   â”œâ”€â”€ å®šåƒ¹æ–¹æ¡ˆ
â”‚   â”œâ”€â”€ éƒ¨è½æ ¼
â”‚   â””â”€â”€ è¯çµ¡æˆ‘å€‘
â”œâ”€â”€ ğŸ” èªè­‰é é¢
â”‚   â”œâ”€â”€ ç™»å…¥
â”‚   â”œâ”€â”€ è¨»å†Š
â”‚   â””â”€â”€ å¿˜è¨˜å¯†ç¢¼
â””â”€â”€ ğŸ“Š æ‡‰ç”¨ç¨‹å¼ï¼ˆéœ€ç™»å…¥ï¼‰
    â”œâ”€â”€ ğŸ  å„€è¡¨æ¿ï¼ˆé¦–é ï¼‰
    â”‚   â”œâ”€â”€ æœ¬æœˆç‡Ÿæ”¶æ‘˜è¦
    â”‚   â”œâ”€â”€ å¾…è™•ç†äº‹é …
    â”‚   â”œâ”€â”€ æ‡‰æ”¶å¸³æ¬¾å¸³é½¡åœ–
    â”‚   â”œâ”€â”€ å¿«é€Ÿæ“ä½œæŒ‰éˆ•
    â”‚   â””â”€â”€ ğŸ”” é€šçŸ¥éˆ´éºï¼ˆå³ä¸Šè§’ï¼‰
    â”œâ”€â”€ ğŸ‘¥ å®¢æˆ¶/å» å•†
    â”‚   â”œâ”€â”€ åˆ—è¡¨
    â”‚   â””â”€â”€ æ–°å¢/ç·¨è¼¯
    â”œâ”€â”€ ğŸ“¦ å•†å“
    â”‚   â”œâ”€â”€ åˆ—è¡¨
    â”‚   â””â”€â”€ æ–°å¢/ç·¨è¼¯
    â”œâ”€â”€ ğŸ“ å ±åƒ¹å–®
    â”‚   â”œâ”€â”€ åˆ—è¡¨
    â”‚   â”œâ”€â”€ æ–°å¢/ç·¨è¼¯
    â”‚   â””â”€â”€ è©³æƒ…ï¼ˆå«è½‰è¨‚å–®ï¼‰
    â”œâ”€â”€ ğŸ“‹ è¨‚å–®
    â”‚   â”œâ”€â”€ åˆ—è¡¨
    â”‚   â”œâ”€â”€ æ–°å¢/ç·¨è¼¯
    â”‚   â””â”€â”€ è©³æƒ…ï¼ˆå«å‡ºè²¨ï¼‰
    â”œâ”€â”€ ğŸšš å‡ºè²¨å–®
    â”‚   â”œâ”€â”€ åˆ—è¡¨
    â”‚   â””â”€â”€ è©³æƒ…
    â”œâ”€â”€ ğŸ§¾ ç™¼ç¥¨
    â”‚   â”œâ”€â”€ åˆ—è¡¨
    â”‚   â”œâ”€â”€ æ–°å¢/ç·¨è¼¯
    â”‚   â””â”€â”€ è©³æƒ…ï¼ˆå«æ”¶æ¬¾è¨˜éŒ„ï¼‰
    â”œâ”€â”€ ğŸ“Š è²¡å‹™å ±è¡¨
    â”‚   â”œâ”€â”€ æç›Šè¡¨
    â”‚   â”œâ”€â”€ è³‡ç”¢è² å‚µè¡¨
    â”‚   â”œâ”€â”€ ç¾é‡‘æµé‡è¡¨
    â”‚   â”œâ”€â”€ æ‡‰æ”¶å¸³æ¬¾å¸³é½¡
    â”‚   â””â”€â”€ æ‡‰ä»˜å¸³æ¬¾å¸³é½¡
    â”œâ”€â”€ ğŸ’° ç¨…å‹™ç”³å ± [Standard+]
    â”‚   â”œâ”€â”€ ç‡Ÿæ¥­ç¨… 401
    â”‚   â”‚   â”œâ”€â”€ æœŸåˆ¥é¸æ“‡
    â”‚   â”‚   â”œâ”€â”€ è³‡æ–™é è¦½
    â”‚   â”‚   â””â”€â”€ ç”¢å‡ºç”³å ±æª”
    â”‚   â””â”€â”€ ç‡Ÿæ‰€ç¨… [Pro]
    â”‚       â”œâ”€â”€ è³‡æ–™è¼¸å…¥
    â”‚       â””â”€â”€ è©¦ç®—çµæœ
    â”œâ”€â”€ ğŸ”” é€šçŸ¥ä¸­å¿ƒ
    â”‚   â””â”€â”€ é€šçŸ¥åˆ—è¡¨ï¼ˆå…¨éƒ¨/æœªè®€ï¼‰
    â””â”€â”€ âš™ï¸ è¨­å®š
        â”œâ”€â”€ å…¬å¸è³‡æ–™
        â”œâ”€â”€ ä½¿ç”¨è€…ç®¡ç† [å¤šäººæ–¹æ¡ˆ]
        â”œâ”€â”€ ğŸ“§ é€šçŸ¥è¨­å®š
        â”‚   â”œâ”€â”€ æ¥æ”¶ Email è¨­å®š
        â”‚   â”œâ”€â”€ é€šçŸ¥é¡å‹é–‹é—œ
        â”‚   â”œâ”€â”€ æé†’å¤©æ•¸è¨­å®š
        â”‚   â””â”€â”€ Email é€šçŸ¥ç¸½é–‹é—œ
        â”œâ”€â”€ é›»å­ç™¼ç¥¨è¨­å®š [Standard+]
        â””â”€â”€ å¸³è™Ÿèˆ‡è¨‚é–±
```

### 6.2 é€šçŸ¥éˆ´éºå…ƒä»¶

```typescript
// components/layout/notification-bell.tsx

'use client';

import { Bell } from 'lucide-react';
import { useNotifications } from '@/hooks/use-notifications';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { formatDistanceToNow } from 'date-fns';
import { zhTW } from 'date-fns/locale';
import Link from 'next/link';

export function NotificationBell() {
  const { 
    notifications, 
    unreadCount, 
    markAsRead, 
    markAllAsRead,
    isLoading 
  } = useNotifications();

  return (
    <Popover>
      <PopoverTrigger asChild>
        <Button variant="ghost" size="icon" className="relative">
          <Bell className="h-5 w-5" />
          {unreadCount > 0 && (
            <span className="absolute -top-1 -right-1 h-5 w-5 rounded-full bg-red-500 text-white text-xs flex items-center justify-center">
              {unreadCount > 99 ? '99+' : unreadCount}
            </span>
          )}
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-80 p-0" align="end">
        <div className="flex items-center justify-between p-4 border-b">
          <h3 className="font-semibold">é€šçŸ¥</h3>
          {unreadCount > 0 && (
            <Button 
              variant="ghost" 
              size="sm"
              onClick={() => markAllAsRead()}
            >
              å…¨éƒ¨æ¨™ç‚ºå·²è®€
            </Button>
          )}
        </div>
        <ScrollArea className="h-[400px]">
          {notifications.length === 0 ? (
            <div className="p-4 text-center text-muted-foreground">
              ç›®å‰æ²’æœ‰é€šçŸ¥
            </div>
          ) : (
            <div className="divide-y">
              {notifications.map((notification) => (
                <Link
                  key={notification.id}
                  href={getNotificationLink(notification)}
                  onClick={() => !notification.is_read && markAsRead(notification.id)}
                  className={`block p-4 hover:bg-muted transition-colors ${
                    !notification.is_read ? 'bg-blue-50' : ''
                  }`}
                >
                  <div className="flex items-start gap-3">
                    <div className={`w-2 h-2 rounded-full mt-2 ${
                      !notification.is_read ? 'bg-blue-500' : 'bg-transparent'
                    }`} />
                    <div className="flex-1 min-w-0">
                      <p className="font-medium text-sm">{notification.title}</p>
                      <p className="text-sm text-muted-foreground line-clamp-2">
                        {notification.message}
                      </p>
                      <p className="text-xs text-muted-foreground mt-1">
                        {formatDistanceToNow(new Date(notification.created_at), {
                          addSuffix: true,
                          locale: zhTW,
                        })}
                      </p>
                    </div>
                  </div>
                </Link>
              ))}
            </div>
          )}
        </ScrollArea>
        <div className="p-2 border-t">
          <Button variant="ghost" className="w-full" asChild>
            <Link href="/notifications">æŸ¥çœ‹å…¨éƒ¨é€šçŸ¥</Link>
          </Button>
        </div>
      </PopoverContent>
    </Popover>
  );
}

function getNotificationLink(notification: Notification): string {
  if (notification.reference_type && notification.reference_id) {
    const typeMap: Record<string, string> = {
      INVOICE: 'invoices',
      QUOTE: 'quotes',
      ORDER: 'orders',
    };
    const path = typeMap[notification.reference_type];
    if (path) {
      return `/${path}/${notification.reference_id}`;
    }
  }
  return '/notifications';
}
```

### 6.3 é€šçŸ¥è¨­å®šé é¢

```typescript
// app/(dashboard)/settings/notifications/page.tsx

'use client';

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Switch } from '@/components/ui/switch';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { useNotificationSettings, updateNotificationSettings } from '@/hooks/use-notification-settings';
import { toast } from 'sonner';
import { Plus, X } from 'lucide-react';
import { useState } from 'react';

const NOTIFICATION_TYPES = [
  { id: 'PAYMENT_DUE', label: 'æ¬¾é …å³å°‡åˆ°æœŸ', description: 'åœ¨ç™¼ç¥¨åˆ°æœŸå‰ç™¼é€æé†’' },
  { id: 'PAYMENT_OVERDUE', label: 'æ¬¾é …å·²é€¾æœŸ', description: 'ç•¶ç™¼ç¥¨è¶…éåˆ°æœŸæ—¥æ™‚é€šçŸ¥' },
  { id: 'QUOTE_EXPIRING', label: 'å ±åƒ¹å–®å³å°‡åˆ°æœŸ', description: 'åœ¨å ±åƒ¹å–®æœ‰æ•ˆæœŸé™å‰ç™¼é€æé†’' },
  { id: 'QUOTE_ACCEPTED', label: 'å ±åƒ¹å–®å·²æ¥å—', description: 'ç•¶å®¢æˆ¶æ¥å—å ±åƒ¹æ™‚é€šçŸ¥' },
  { id: 'ORDER_CONFIRMED', label: 'è¨‚å–®å·²ç¢ºèª', description: 'ç•¶è¨‚å–®ç¢ºèªæ™‚é€šçŸ¥' },
  { id: 'PAYMENT_RECEIVED', label: 'å·²æ”¶åˆ°ä»˜æ¬¾', description: 'ç•¶è¨˜éŒ„æ”¶æ¬¾æ™‚é€šçŸ¥' },
];

const formSchema = z.object({
  email_recipients: z.array(z.string().email('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email')),
  enabled_types: z.array(z.string()),
  payment_due_days: z.number().min(1).max(30),
  payment_overdue_enabled: z.boolean(),
  quote_expiring_days: z.number().min(1).max(30),
  email_enabled: z.boolean(),
});

type FormData = z.infer<typeof formSchema>;

export default function NotificationSettingsPage() {
  const { settings, isLoading } = useNotificationSettings();
  const [newEmail, setNewEmail] = useState('');
  
  const form = useForm<FormData>({
    resolver: zodResolver(formSchema),
    defaultValues: settings,
  });

  const emailRecipients = form.watch('email_recipients') || [];
  const emailEnabled = form.watch('email_enabled');

  const addEmail = () => {
    if (newEmail && z.string().email().safeParse(newEmail).success) {
      if (!emailRecipients.includes(newEmail)) {
        form.setValue('email_recipients', [...emailRecipients, newEmail]);
        setNewEmail('');
      }
    } else {
      toast.error('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email');
    }
  };

  const removeEmail = (email: string) => {
    form.setValue('email_recipients', emailRecipients.filter(e => e !== email));
  };

  const toggleNotificationType = (type: string, enabled: boolean) => {
    const current = form.getValues('enabled_types') || [];
    if (enabled) {
      form.setValue('enabled_types', [...current, type]);
    } else {
      form.setValue('enabled_types', current.filter(t => t !== type));
    }
  };

  const onSubmit = async (data: FormData) => {
    try {
      await updateNotificationSettings(data);
      toast.success('é€šçŸ¥è¨­å®šå·²å„²å­˜');
    } catch (error) {
      toast.error('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  };

  if (isLoading) {
    return <div>è¼‰å…¥ä¸­...</div>;
  }

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-bold">é€šçŸ¥è¨­å®š</h1>
        <p className="text-muted-foreground">
          è¨­å®šæ‚¨æƒ³è¦æ¥æ”¶çš„é€šçŸ¥é¡å‹å’Œæ–¹å¼
        </p>
      </div>

      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
        {/* Email é€šçŸ¥ç¸½é–‹é—œ */}
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <div>
                <CardTitle>Email é€šçŸ¥</CardTitle>
                <CardDescription>é–‹å•Ÿå¾Œå°‡æœƒç™¼é€ Email é€šçŸ¥åˆ°æŒ‡å®šä¿¡ç®±</CardDescription>
              </div>
              <Switch
                checked={emailEnabled}
                onCheckedChange={(checked) => form.setValue('email_enabled', checked)}
              />
            </div>
          </CardHeader>
        </Card>

        {/* æ¥æ”¶ Email è¨­å®š */}
        <Card className={!emailEnabled ? 'opacity-50' : ''}>
          <CardHeader>
            <CardTitle>æ¥æ”¶é€šçŸ¥çš„ Email</CardTitle>
            <CardDescription>å¯è¨­å®šå¤šå€‹ Email åŒæ™‚æ¥æ”¶é€šçŸ¥</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="flex gap-2">
              <Input
                type="email"
                placeholder="è¼¸å…¥ Email åœ°å€"
                value={newEmail}
                onChange={(e) => setNewEmail(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), addEmail())}
                disabled={!emailEnabled}
              />
              <Button type="button" onClick={addEmail} disabled={!emailEnabled}>
                <Plus className="h-4 w-4" />
              </Button>
            </div>
            <div className="flex flex-wrap gap-2">
              {emailRecipients.map((email) => (
                <div
                  key={email}
                  className="flex items-center gap-1 bg-muted px-3 py-1 rounded-full"
                >
                  <span className="text-sm">{email}</span>
                  <button
                    type="button"
                    onClick={() => removeEmail(email)}
                    className="text-muted-foreground hover:text-foreground"
                    disabled={!emailEnabled}
                  >
                    <X className="h-3 w-3" />
                  </button>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>

        {/* é€šçŸ¥é¡å‹è¨­å®š */}
        <Card className={!emailEnabled ? 'opacity-50' : ''}>
          <CardHeader>
            <CardTitle>é€šçŸ¥é¡å‹</CardTitle>
            <CardDescription>é¸æ“‡æ‚¨æƒ³è¦æ¥æ”¶çš„é€šçŸ¥é¡å‹</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            {NOTIFICATION_TYPES.map((type) => (
              <div key={type.id} className="flex items-center justify-between">
                <div>
                  <Label>{type.label}</Label>
                  <p className="text-sm text-muted-foreground">{type.description}</p>
                </div>
                <Switch
                  checked={form.watch('enabled_types')?.includes(type.id)}
                  onCheckedChange={(checked) => toggleNotificationType(type.id, checked)}
                  disabled={!emailEnabled}
                />
              </div>
            ))}
          </CardContent>
        </Card>

        {/* æé†’å¤©æ•¸è¨­å®š */}
        <Card className={!emailEnabled ? 'opacity-50' : ''}>
          <CardHeader>
            <CardTitle>æé†’æ™‚é–“è¨­å®š</CardTitle>
            <CardDescription>è¨­å®šæå‰å¹¾å¤©ç™¼é€æé†’</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="flex items-center justify-between">
              <Label>æ¬¾é …åˆ°æœŸå‰æé†’</Label>
              <div className="flex items-center gap-2">
                <Input
                  type="number"
                  className="w-20"
                  min={1}
                  max={30}
                  {...form.register('payment_due_days', { valueAsNumber: true })}
                  disabled={!emailEnabled}
                />
                <span className="text-sm text-muted-foreground">å¤©</span>
              </div>
            </div>
            <div className="flex items-center justify-between">
              <Label>å ±åƒ¹å–®åˆ°æœŸå‰æé†’</Label>
              <div className="flex items-center gap-2">
                <Input
                  type="number"
                  className="w-20"
                  min={1}
                  max={30}
                  {...form.register('quote_expiring_days', { valueAsNumber: true })}
                  disabled={!emailEnabled}
                />
                <span className="text-sm text-muted-foreground">å¤©</span>
              </div>
            </div>
          </CardContent>
        </Card>

        <Button type="submit" disabled={form.formState.isSubmitting}>
          {form.formState.isSubmitting ? 'å„²å­˜ä¸­...' : 'å„²å­˜è¨­å®š'}
        </Button>
      </form>
    </div>
  );
}
```

---

## 7. æ¥­å‹™é‚è¼¯è¦æ ¼

### 7.1 å ±åƒ¹å–®è½‰æ›æµç¨‹

```mermaid
flowchart LR
    QUOTE[å ±åƒ¹å–®<br/>DRAFT] --> |ç™¼é€| SENT[å ±åƒ¹å–®<br/>SENT]
    SENT --> |å®¢æˆ¶åŒæ„| ACCEPTED[å ±åƒ¹å–®<br/>ACCEPTED]
    SENT --> |å®¢æˆ¶æ‹’çµ•| REJECTED[å ±åƒ¹å–®<br/>REJECTED]
    SENT --> |è¶…éæœŸé™| EXPIRED[å ±åƒ¹å–®<br/>EXPIRED]
    ACCEPTED --> |è½‰æ›| ORDER[è¨‚å–®<br/>PENDING]
    ORDER --> |ç¢ºèª| CONFIRMED[è¨‚å–®<br/>CONFIRMED]
    CONFIRMED --> |å‡ºè²¨| SHIPMENT[å‡ºè²¨å–®]
    CONFIRMED --> |è«‹æ¬¾| INVOICE[ç™¼ç¥¨<br/>DRAFT]
    INVOICE --> |é–‹ç«‹| ISSUED[ç™¼ç¥¨<br/>ISSUED]
    ISSUED --> |æ”¶æ¬¾| PAID[ç™¼ç¥¨<br/>PAID]
    ISSUED --> |é€¾æœŸ| OVERDUE[ç™¼ç¥¨<br/>OVERDUE]
```

### 7.2 é€šçŸ¥è§¸ç™¼è¦å‰‡

| è§¸ç™¼äº‹ä»¶ | é€šçŸ¥é¡å‹ | è§¸ç™¼æ™‚æ©Ÿ | ç¶²ç«™é€šçŸ¥ | Email |
|---------|---------|---------|:--------:|:-----:|
| ç™¼ç¥¨å³å°‡åˆ°æœŸ | `PAYMENT_DUE` | åˆ°æœŸå‰ N å¤©ï¼ˆæ’ç¨‹ï¼‰ | âœ… | âœ… |
| ç™¼ç¥¨å·²é€¾æœŸ | `PAYMENT_OVERDUE` | è¶…éåˆ°æœŸæ—¥ï¼ˆæ’ç¨‹ï¼‰ | âœ… | âœ… |
| å ±åƒ¹å–®å³å°‡åˆ°æœŸ | `QUOTE_EXPIRING` | æœ‰æ•ˆæœŸé™å‰ N å¤©ï¼ˆæ’ç¨‹ï¼‰ | âœ… | âœ… |
| å ±åƒ¹å–®è¢«æ¥å— | `QUOTE_ACCEPTED` | ç‹€æ…‹è®Šæ›´æ™‚ï¼ˆå³æ™‚ï¼‰ | âœ… | âœ… |
| è¨‚å–®å·²ç¢ºèª | `ORDER_CONFIRMED` | ç‹€æ…‹è®Šæ›´æ™‚ï¼ˆå³æ™‚ï¼‰ | âœ… | âœ… |
| æ”¶åˆ°ä»˜æ¬¾ | `PAYMENT_RECEIVED` | è¨˜éŒ„ä»˜æ¬¾æ™‚ï¼ˆå³æ™‚ï¼‰ | âœ… | âœ… |

> N å¤©ç”±ç”¨æˆ¶åœ¨ã€Œé€šçŸ¥è¨­å®šã€ä¸­è‡ªè¨‚

### 7.3 ç‡Ÿæ¥­ç¨… 401 ç”³å ±æª”ç”¢å‡º

```typescript
// lib/utils/vat-media-generator.ts

interface VatReportData {
  taxId: string;
  year: number;
  period: number;
  salesItems: SalesItem[];
  purchaseItems: PurchaseItem[];
}

interface SalesItem {
  buyerTaxId: string;
  invoiceDate: Date;
  invoiceNumber: string;
  salesAmount: number;
  taxAmount: number;
  taxType: string;
}

export function generateVat401Media(data: VatReportData): string {
  const lines: string[] = [];
  
  // è¡¨é ­è¨˜éŒ„ (H)
  lines.push(generateHeaderRecord(data));
  
  // éŠ·é …æ˜ç´° (S)
  for (const item of data.salesItems) {
    lines.push(generateSalesRecord(item, data.taxId));
  }
  
  // é€²é …æ˜ç´° (P)
  for (const item of data.purchaseItems) {
    lines.push(generatePurchaseRecord(item, data.taxId));
  }
  
  // è¡¨å°¾è¨˜éŒ„ (T)
  lines.push(generateTrailerRecord(data));
  
  return lines.join('\r\n');
}

function generateHeaderRecord(data: VatReportData): string {
  const year = (data.year - 1911).toString().padStart(3, '0');
  const period = data.period.toString().padStart(2, '0');
  return `H${data.taxId}${year}${period}${' '.repeat(67)}`;
}

function generateSalesRecord(item: SalesItem, sellerTaxId: string): string {
  const yearMonth = formatYearMonth(item.invoiceDate);
  const amount = Math.round(item.salesAmount).toString().padStart(12, '0');
  const tax = Math.round(item.taxAmount).toString().padStart(10, '0');
  
  return `S31${item.buyerTaxId.padEnd(8)}${yearMonth}${item.invoiceNumber.padEnd(10)}${amount}${item.taxType}${tax}${' '.repeat(23)}`;
}

function formatYearMonth(date: Date): string {
  const year = date.getFullYear() - 1911;
  const month = (date.getMonth() + 1).toString().padStart(2, '0');
  return `${year}${month}`;
}
```

### 7.4 ç‡Ÿæ‰€ç¨…æ“´å¤§æ›¸å¯©è¨ˆç®—

```typescript
// lib/utils/tax-calculator.ts

// æ“´å¤§æ›¸å¯©ç´”ç›Šç‡è¡¨ï¼ˆéƒ¨åˆ†è¡Œæ¥­ï¼‰
const INDUSTRY_PROFIT_RATES: Record<string, number> = {
  '4510': 0.06, // æ±½è»Šé›¶å”®æ¥­
  '4610': 0.06, // å•†å“æ‰¹ç™¼ç¶“ç´€æ¥­
  '4641': 0.06, // å¸ƒç–‹åŠæœé£¾å“æ‰¹ç™¼æ¥­
  '4711': 0.06, // é›¶å”®å¼é‡è²©æ¥­
  '4719': 0.06, // å…¶ä»–ç¶œåˆå•†å“é›¶å”®æ¥­
  '4721': 0.08, // è”¬æœé›¶å”®æ¥­
  '5610': 0.08, // é¤é¤¨æ¥­
  '5820': 0.10, // è»Ÿé«”å‡ºç‰ˆæ¥­
  '6201': 0.10, // é›»è…¦ç¨‹å¼è¨­è¨ˆæ¥­
  '6202': 0.10, // é›»è…¦è«®è©¢æœå‹™æ¥­
  '7010': 0.12, // ä¼æ¥­ç¸½ç®¡ç†æ©Ÿæ§‹
  '7020': 0.10, // ç®¡ç†é¡§å•æ¥­
};

interface IncomeTaxInput {
  revenue: number;
  nonOperatingIncome: number;
  industryCode: string;
}

interface IncomeTaxResult {
  year: number;
  revenue: number;
  nonOperatingIncome: number;
  industryCode: string;
  profitRate: number;
  taxableIncome: number;
  taxAmount: number;
}

export function calculateIncomeTax(input: IncomeTaxInput): IncomeTaxResult {
  const profitRate = INDUSTRY_PROFIT_RATES[input.industryCode] ?? 0.06;
  
  // èª²ç¨…æ‰€å¾—é¡ = (ç‡Ÿæ¥­æ”¶å…¥ Ã— ç´”ç›Šç‡) + éç‡Ÿæ¥­æ”¶å…¥
  const taxableIncome = Math.round(input.revenue * profitRate + input.nonOperatingIncome);
  
  // ç‡Ÿæ‰€ç¨…ç‡ 20%
  // èª²ç¨…æ‰€å¾—é¡ 12è¬ä»¥ä¸‹å…ç¨…
  let taxAmount = 0;
  if (taxableIncome > 120000) {
    taxAmount = Math.round(taxableIncome * 0.20);
  }
  
  return {
    year: new Date().getFullYear() - 1,
    revenue: input.revenue,
    nonOperatingIncome: input.nonOperatingIncome,
    industryCode: input.industryCode,
    profitRate,
    taxableIncome,
    taxAmount,
  };
}
```

---

## 8. é–‹ç™¼éšæ®µè¦åŠƒ

### 8.1 Phase 1ï¼šæ ¸å¿ƒåŸºç¤ (MVP)

**é è¨ˆæ™‚ç¨‹**: 6-8 é€±

**åŠŸèƒ½ç¯„åœ**:
- [ ] Next.js å°ˆæ¡ˆæ¶æ§‹å»ºç½®
- [ ] Supabase å°ˆæ¡ˆè¨­å®šï¼ˆDatabaseã€Authï¼‰
- [ ] ç”¨æˆ¶èªè­‰ï¼ˆè¨»å†Šã€ç™»å…¥ã€å¿˜è¨˜å¯†ç¢¼ï¼‰
- [ ] çµ„ç¹”/å…¬å¸è¨­å®š
- [ ] å®¢æˆ¶/å» å•†ç®¡ç† CRUD
- [ ] å•†å“ç®¡ç† CRUD
- [ ] å ±åƒ¹å–®å®Œæ•´æµç¨‹
- [ ] å„€è¡¨æ¿åŸºç¤ç‰ˆ
- [ ] åŸºæœ¬è²¡å‹™å ±è¡¨ï¼ˆæç›Šè¡¨ï¼‰
- [ ] é€šçŸ¥ä¸­å¿ƒåŸºç¤æ¶æ§‹
- [ ] Email é€šçŸ¥åŸºç¤ï¼ˆResend æ•´åˆï¼‰

**äº¤ä»˜ç‰©**:
- å¯é‹ä½œçš„ MVP ç‰ˆæœ¬
- Entry æ–¹æ¡ˆå¯é–‹å§‹æ”¶è²»

### 8.2 Phase 2ï¼šå®Œæ•´äº¤æ˜“æµç¨‹

**é è¨ˆæ™‚ç¨‹**: 4-5 é€±

**åŠŸèƒ½ç¯„åœ**:
- [ ] è¨‚å–®ç®¡ç†
- [ ] å‡ºè²¨å–®ç®¡ç†
- [ ] ç™¼ç¥¨ç®¡ç†ï¼ˆå…§éƒ¨ç™¼ç¥¨ï¼Œéé›»å­ç™¼ç¥¨ï¼‰
- [ ] æ”¶æ¬¾è¨˜éŒ„
- [ ] å®Œæ•´è²¡å‹™å ±è¡¨ï¼ˆè³‡ç”¢è² å‚µè¡¨ã€ç¾é‡‘æµé‡è¡¨ï¼‰
- [ ] é€²éŠ·å­˜åŸºç¤åŠŸèƒ½
- [ ] é€šçŸ¥è¨­å®šé é¢ï¼ˆå®Œæ•´åŠŸèƒ½ï¼‰
- [ ] Cloudflare Workers æ’ç¨‹ï¼ˆåˆ°æœŸæª¢æŸ¥ï¼‰

### 8.3 Phase 3ï¼šç‡Ÿæ¥­ç¨…ç”³å ±

**é è¨ˆæ™‚ç¨‹**: 2-3 é€±

**åŠŸèƒ½ç¯„åœ**:
- [ ] 401 ç”³å ±è³‡æ–™å½™æ•´
- [ ] Media ç”³å ±æª”ç”¢å‡º
- [ ] PDF é è¦½
- [ ] ç”³å ±è¨˜éŒ„ç®¡ç†

**äº¤ä»˜ç‰©**:
- Standard æ–¹æ¡ˆå¯é–‹å§‹æ”¶è²»

### 8.4 Phase 4ï¼šé›»å­ç™¼ç¥¨ä¸²æ¥

**é è¨ˆæ™‚ç¨‹**: 2-3 é€±

**åŠŸèƒ½ç¯„åœ**:
- [ ] Payuni å¸³è™Ÿè¨­å®š
- [ ] B2B ç™¼ç¥¨é–‹ç«‹
- [ ] B2C ç™¼ç¥¨é–‹ç«‹
- [ ] ç™¼ç¥¨ä½œå»¢/æŠ˜è®“
- [ ] Webhook å›èª¿è™•ç†

### 8.5 Phase 5ï¼šç‡Ÿæ‰€ç¨…è¨ˆç®—

**é è¨ˆæ™‚ç¨‹**: 2 é€±

**åŠŸèƒ½ç¯„åœ**:
- [ ] æ“´å¤§æ›¸å¯©ç´”ç›Šç‡è³‡æ–™åº«
- [ ] ç¨…é¡è©¦ç®—åŠŸèƒ½
- [ ] ç”³å ±æ›¸è¡¨ç”¢å‡º

**äº¤ä»˜ç‰©**:
- Pro æ–¹æ¡ˆå®Œæ•´åŠŸèƒ½

### 8.6 Phase 6ï¼šè¡ŒéŠ·é é¢èˆ‡ SEO

**é è¨ˆæ™‚ç¨‹**: 2-3 é€±

**åŠŸèƒ½ç¯„åœ**:
- [ ] ç”¢å“ä»‹ç´¹é é¢
- [ ] å®šåƒ¹é é¢
- [ ] åŠŸèƒ½ä»‹ç´¹é é¢
- [ ] éƒ¨è½æ ¼ç³»çµ±
- [ ] SEO å„ªåŒ–
- [ ] è¯ç›Ÿè¡ŒéŠ·æ•´åˆï¼ˆåƒè€ƒ affiliate å°ˆæ¡ˆï¼‰

---

## 9. é©—è­‰è¨ˆç•«

### 9.1 è‡ªå‹•åŒ–æ¸¬è©¦

**å–®å…ƒæ¸¬è©¦**:
- ç¨…é¡è¨ˆç®—é‚è¼¯
- å ±åƒ¹å–®é‡‘é¡è¨ˆç®—
- 401 Media æª”æ ¼å¼ç”¢å‡º
- é€šçŸ¥è§¸ç™¼é‚è¼¯

**æ•´åˆæ¸¬è©¦**:
- å ±åƒ¹å–® â†’ è¨‚å–® â†’ ç™¼ç¥¨ è½‰æ›æµç¨‹
- Payuni API ä¸²æ¥
- Resend Email ç™¼é€
- æ’ç¨‹ä»»å‹™åŸ·è¡Œ

### 9.2 æ‰‹å‹•é©—è­‰é …ç›®

| é …ç›® | é©—è­‰å…§å®¹ |
|------|---------|
| å ±åƒ¹å–®æµç¨‹ | æ–°å¢ â†’ ç™¼é€ â†’ è½‰è¨‚å–® â†’ å‡ºè²¨ â†’ é–‹ç™¼ç¥¨ |
| è²¡å‹™å ±è¡¨ | æ•¸å­—æ­£ç¢ºæ€§ã€å ±è¡¨æ ¼å¼ |
| 401 ç”³å ± | ç”³å ±æª”æ ¼å¼ã€é‡‘é¡æ­£ç¢ºæ€§ |
| é›»å­ç™¼ç¥¨ | B2B/B2C é–‹ç«‹ã€ä½œå»¢æµç¨‹ |
| é€šçŸ¥åŠŸèƒ½ | Email ç™¼é€ã€é€šçŸ¥ä¸­å¿ƒé¡¯ç¤ºã€å·²è®€ç‹€æ…‹ |
| é€šçŸ¥è¨­å®š | å¤š Emailã€é¡å‹é–‹é—œã€å¤©æ•¸è¨­å®š |
| æ¬Šé™æ§ç®¡ | ä¸åŒè§’è‰²çš„å­˜å–é™åˆ¶ |

---

## 10. é™„éŒ„

### 10.1 åè©å°ç…§è¡¨

| ä¸­æ–‡è¡“èª | è‹±æ–‡å°æ‡‰ | èªªæ˜ |
|---------|---------|------|
| å ±åƒ¹å–® | Quote | å‘å®¢æˆ¶æä¾›çš„å ±åƒ¹æ–‡ä»¶ |
| è¨‚å–® | Order | å®¢æˆ¶ç¢ºèªçš„æ¡è³¼å–® |
| å‡ºè²¨å–® | Shipment | å•†å“å‡ºè²¨è¨˜éŒ„ |
| ç™¼ç¥¨ | Invoice | è«‹æ¬¾æ†‘è­‰ |
| çµ±ä¸€ç·¨è™Ÿ | Tax ID | å°ç£ç‡Ÿæ¥­äººè­˜åˆ¥ç¢¼ (8ç¢¼) |
| ç‡Ÿæ¥­ç¨… | VAT | Value Added Tax (5%) |
| ç‡Ÿæ‰€ç¨… | Income Tax | ç‡Ÿåˆ©äº‹æ¥­æ‰€å¾—ç¨… (20%) |
| æ“´å¤§æ›¸å¯© | Expanded Audit | ç°¡åŒ–çš„ç‡Ÿæ‰€ç¨…ç”³å ±æ–¹å¼ |
| ç´”ç›Šç‡ | Profit Rate | æ“´å¤§æ›¸å¯©é©ç”¨çš„è¡Œæ¥­ç´”ç›Šç‡ |

### 10.2 ç‡Ÿæ¥­ç¨…ç”³å ±æœŸåˆ¥

| æœŸåˆ¥ | ç”³å ±æœˆä»½ç¯„åœ | ç”³å ±æˆªæ­¢æ—¥ |
|------|-------------|-----------|
| ç¬¬ 1 æœŸ | 1-2 æœˆ | 3/15 |
| ç¬¬ 2 æœŸ | 3-4 æœˆ | 5/15 |
| ç¬¬ 3 æœŸ | 5-6 æœˆ | 7/15 |
| ç¬¬ 4 æœŸ | 7-8 æœˆ | 9/15 |
| ç¬¬ 5 æœŸ | 9-10 æœˆ | 11/15 |
| ç¬¬ 6 æœŸ | 11-12 æœˆ | éš”å¹´ 1/15 |

### 10.3 ä½¿ç”¨è€…è§’è‰²æ¬Šé™

| åŠŸèƒ½ | ç®¡ç†å“¡ | æœƒè¨ˆ | æ¥­å‹™ |
|------|:------:|:----:|:----:|
| ç³»çµ±è¨­å®š | âœ… | âŒ | âŒ |
| ä½¿ç”¨è€…ç®¡ç† | âœ… | âŒ | âŒ |
| é€šçŸ¥è¨­å®š | âœ… | âŒ | âŒ |
| å®¢æˆ¶ç®¡ç† | âœ… | âœ… | âœ… |
| å ±åƒ¹å–® | âœ… | âœ… | âœ… |
| è¨‚å–® | âœ… | âœ… | ğŸ‘ï¸ |
| ç™¼ç¥¨ | âœ… | âœ… | ğŸ‘ï¸ |
| æ”¶æ¬¾è¨˜éŒ„ | âœ… | âœ… | âŒ |
| è²¡å‹™å ±è¡¨ | âœ… | âœ… | âŒ |
| ç¨…å‹™ç”³å ± | âœ… | âœ… | âŒ |
| é€šçŸ¥ä¸­å¿ƒ | âœ… | âœ… | âœ… |

> ğŸ‘ï¸ = åƒ…æª¢è¦–æ¬Šé™

---

## 11. ç‰ˆæœ¬æ­·ç¨‹

| ç‰ˆæœ¬ | æ—¥æœŸ | è®Šæ›´èªªæ˜ |
|------|------|---------|
| 1.0 | 2026-01-09 | åˆç‰ˆå»ºç«‹ |
| 1.1 | 2026-01-09 | æŠ€è¡“æ¶æ§‹èª¿æ•´ç‚º Flutter App + Next.js è¡ŒéŠ·é  |
| 1.2 | 2026-01-09 | æ¶æ§‹å¤§æ”¹ï¼šæ”¹ç‚º Next.js å…¨åŠŸèƒ½ç¶²ç«™ï¼›ç§»é™¤ Appï¼›é€šçŸ¥æ”¹ç”¨ Email + ç¶²ç«™å…§é€šçŸ¥ä¸­å¿ƒï¼›éƒ¨ç½²æ”¹ç”¨ Cloudflare Pagesï¼›æ–°å¢å®Œæ•´é€šçŸ¥è¨­å®šåŠŸèƒ½ |

# 提案：優化收款管理儀表板

## 概述

現有收款管理頁面缺少與報價單的直接關聯，且當月應收款項管理功能不足。本提案旨在：
1. 在儀表板增加當月應收款項清單，顯示報價單編號、金額、期數
2. 提供打勾功能標記款項已收
3. 移除收款率卡片（替換為更實用的當月應收統計）
4. 優化未收款和已收款區域的資料展示

## 問題陳述

### 當前痛點
1. **缺少當月應收款項管理**：使用者無法快速查看本月需要收取的款項
2. **報價單關聯不明確**：收款記錄沒有顯示報價單編號和期數
3. **收款率卡片價值低**：簡單的百分比數字缺乏可操作性
4. **逾期款項判斷不直觀**：缺少基於收款日期的逾期判斷

### 用戶需求
- 財務人員需要每月初快速識別當月應收款項
- 需要通過打勾方式標記收款狀態（類似待辦事項）
- 需要清楚看到報價單編號、期數、金額等關鍵資訊
- 需要自動標記超過收款日期的款項為逾期

## 設計考量

### 參考最佳實踐
根據業界 Accounts Receivable Dashboard 最佳實踐：

1. **核心指標卡片**（參考：Coupler.io, QuantizeAnalytics）
   - 當月已收金額（綠色）
   - 當月未收金額（黃色）
   - 當月逾期金額（紅色）
   - 移除收款率（替換為當月應收總額）

2. **當月應收清單**（新增區域）
   - 顯示本月所有 payment_schedules（due_date 在本月內）
   - 列出：報價單編號、客戶名稱、期數、金額、收款日期、狀態
   - 提供勾選功能標記為已收

3. **未收款/已收款區域優化**
   - 增加報價單編號欄位
   - 顯示期數資訊（第 1 期/共 12 期）
   - 增加收款日期欄位
   - 按逾期天數/收款日期排序

### 技術方案

#### 資料來源
- **當月應收**：查詢 `payment_schedules` 表，篩選 `due_date` 在本月範圍內
- **報價單關聯**：通過 `contract_id` → `customer_contracts.quotation_id` → `quotations.quotation_number`
- **期數資訊**：使用 `schedule_number` 和總期數計算

#### API 端點修改
1. **新增 GET `/api/payments/current-month-receivables`**
   - 返回當月所有應收款項（包含報價單編號、期數）
   - 包含狀態：`pending`（未收）、`paid`（已收）、`overdue`（逾期）

2. **新增 POST `/api/payments/schedules/:id/mark-collected`**
   - 標記某筆 payment_schedule 為已收
   - 創建對應的 payment 記錄
   - 更新 schedule 狀態為 `paid`

3. **修改 GET `/api/payments` 和 `/api/payments/unpaid`**
   - 返回資料增加 `quotation_number` 和 `schedule_info` 欄位

#### UI 組件設計
1. **統計卡片區**（4 張卡片）
   - 當月已收（綠色，顯示金額）
   - 當月未收（黃色，顯示金額）
   - 當月逾期（紅色，顯示金額）
   - 當月應收總額（藍色，顯示金額）

2. **當月應收款項表格**（新增）
   - 欄位：✓（勾選框）、報價單編號、客戶名稱、期數、金額、收款日期、狀態
   - 狀態標籤：未收（黃色）、已收（綠色）、逾期（紅色）
   - 可勾選標記為已收
   - 按收款日期排序

3. **已收款/未收款區域**
   - 增加報價單編號列
   - 增加期數資訊（如「第 3 期/共 12 期」）
   - 增加收款日期列

## 影響範圍

### 前端變更
- `/app/[locale]/payments/page.tsx` - 主要收款管理頁面
- `/components/payments/CurrentMonthReceivables.tsx` - 新增當月應收表格組件
- `/components/payments/PaymentCard.tsx` - 更新卡片組件增加報價單資訊
- `/hooks/usePayments.ts` - 新增 hooks 處理當月應收和標記收款

### 後端變更
- `/app/api/payments/current-month-receivables/route.ts` - 新增 API
- `/app/api/payments/schedules/[id]/mark-collected/route.ts` - 新增 API
- `/lib/dal/payments.ts` - 新增資料存取函式

### 資料庫變更
- 無需 schema 變更（使用現有 `payment_schedules` 表）
- 可能需要新增索引優化查詢效能

### 翻譯檔案
- `/messages/zh.json` - 新增繁體中文翻譯
- `/messages/en.json` - 新增英文翻譯

## 成功標準

### 功能驗證
- [ ] 當月應收款項清單正確顯示本月所有排程
- [ ] 打勾功能可正確標記款項為已收並創建 payment 記錄
- [ ] 統計卡片數據準確反映當月收款狀況
- [ ] 報價單編號和期數資訊正確顯示
- [ ] 逾期判斷邏輯正確（基於 due_date）

### 效能指標
- [ ] 當月應收清單載入時間 < 500ms
- [ ] 標記收款操作回應時間 < 300ms
- [ ] 資料庫查詢使用適當索引

### UX 驗證
- [ ] 介面直觀易用，財務人員可快速找到當月應收
- [ ] 打勾操作流暢，提供即時回饋
- [ ] 資料排序和篩選符合使用習慣
- [ ] 響應式設計在手機和桌面都運作良好

## 時程規劃

- **Phase 1**（2-3 天）：資料庫查詢和 API 開發
- **Phase 2**（2-3 天）：前端組件開發和整合
- **Phase 3**（1-2 天）：測試和優化
- **總計**：約 5-8 個工作日

## 風險評估

### 技術風險
- **低**：使用現有資料表結構，無需 migration
- **低**：API 設計簡單，與現有模式一致

### 相容性風險
- **低**：純粹新增功能，不影響現有收款管理邏輯
- **低**：現有資料不需要遷移

### 效能風險
- **中**：當月應收查詢需要關聯多張表，需注意查詢效能
- **緩解**：加入適當索引，使用 SQL JOIN 優化

## 替代方案

### 方案 A：分階段實施
先實施當月應收清單，後續再加入報價單關聯功能。
- 優點：降低單次變更複雜度
- 缺點：需要多次部署，用戶體驗分段提升

### 方案 B：使用日曆視圖
以日曆形式展示當月應收款項。
- 優點：時間軸視覺化更直觀
- 缺點：開發成本較高，表格形式更符合財務習慣

**選擇建議**：採用本提案（一次性實施所有功能），原因：
1. 功能關聯性強，分階段會影響使用體驗
2. 表格形式更符合財務人員工作習慣
3. 開發成本合理，風險可控

## 相關規範

- `payment-statistics-api` - 統計資料 API
- `dashboard-layout` - 儀表板布局規範
- 新增規範：`payment-current-month-receivables` - 當月應收款項管理

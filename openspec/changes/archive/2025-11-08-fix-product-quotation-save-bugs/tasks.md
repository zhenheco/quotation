# Tasks: fix-product-quotation-save-bugs

## Phase 1: 產品表單送出修復

### 1.1 調查產品表單送出問題
- [ ] 使用 Chrome DevTools 測試產品建立流程
- [ ] 檢查 `ProductForm.tsx` 的 `handleSubmit` 函式
- [ ] 確認 `event.preventDefault()` 是否正確執行
- [ ] 檢查 `useCreateProduct` 和 `useUpdateProduct` hooks 呼叫
- [ ] 使用 Network tab 觀察 API 請求是否送出
- [ ] 檢查 Console 是否有錯誤訊息

**驗證方式**：能明確指出表單送出失敗的原因

---

### 1.2 修復表單送出邏輯
- [ ] 修正 `handleSubmit` 函式中的問題
- [ ] 確保 `createProduct.mutateAsync()` 正確執行
- [ ] 確保 `updateProduct.mutateAsync()` 正確執行
- [ ] 加入適當的 try-catch 錯誤處理
- [ ] 確認表單送出時顯示 loading 狀態

**驗證方式**：點擊「儲存」按鈕後 API 請求成功送出

---

### 1.3 驗證 API 端點
- [ ] 測試 `POST /api/products` 能正確接收資料
- [ ] 測試 `PUT /api/products/{id}` 能正確接收資料
- [ ] 確認 request body 格式符合 API 預期
- [ ] 確認 BilingualText 欄位正確轉換為 JSONB
- [ ] 測試必填欄位驗證

**驗證方式**：使用 Postman 或 curl 直接測試 API

---

### 1.4 確認資料庫寫入
- [ ] 建立新產品後，在資料庫查詢確認記錄存在
- [ ] 編輯產品後，確認資料庫記錄已更新
- [ ] 驗證 `user_id` 正確設定為當前使用者
- [ ] 驗證 JSONB 欄位格式正確
- [ ] 驗證所有欄位類型符合 schema

**驗證方式**：執行 SQL 查詢 `SELECT * FROM products ORDER BY created_at DESC LIMIT 1`

---

### 1.5 完善錯誤處理和使用者回饋
- [ ] 成功建立產品時顯示 success toast
- [ ] 成功更新產品時顯示 success toast
- [ ] API 錯誤時顯示 error toast 並包含錯誤訊息
- [ ] 表單驗證失敗時顯示欄位錯誤訊息
- [ ] 成功後導向產品列表頁面

**驗證方式**：測試各種情境並確認 toast 正確顯示

---

## Phase 2: 報價單自動帶入單價

### 2.1 檢查產品資料結構
- [ ] 確認 `useProducts` hook 回傳的資料包含 `base_price`
- [ ] 檢查 `base_price` 欄位名稱是否一致（vs `unit_price`）
- [ ] 確認產品列表 API 回傳的資料格式
- [ ] 檢查是否有欄位對應邏輯

**驗證方式**：在 Console 印出 products 陣列並檢查資料結構

---

### 2.2 實作自動帶入價格邏輯
- [ ] 修改 `QuotationForm.tsx` 的 `handleItemChange` 函式
- [ ] 在 `field === 'product_id'` 條件中加入價格填入邏輯
- [ ] 從 products 陣列找到對應產品
- [ ] 讀取產品的 `base_price` 並填入 `unit_price`
- [ ] 確保處理 `base_price` 為 null/undefined 的情況

**驗證方式**：選擇產品後 `unit_price` 欄位自動填入價格

---

### 2.3 實作自動重新計算小計
- [ ] 在填入 `unit_price` 後立即重新計算 `subtotal`
- [ ] 使用公式：`subtotal = quantity * unit_price - discount`
- [ ] 確保數值計算正確處理浮點數
- [ ] 更新 items 陣列的對應項目

**驗證方式**：選擇產品後小計自動更新

---

### 2.4 允許使用者手動修改單價
- [ ] 確認 `unit_price` 欄位仍可手動編輯
- [ ] 手動修改後不被自動覆蓋
- [ ] 手動修改後仍能重新計算小計

**驗證方式**：手動修改單價並確認小計更新

---

### 2.5 處理邊界情況
- [ ] 產品沒有 `base_price` 時不顯示錯誤
- [ ] `base_price` 為 0 時正確處理
- [ ] 切換產品時價格正確更新
- [ ] 數量或折扣變更時小計正確更新

**驗證方式**：測試各種邊界情況

---

## Phase 3: 移除硬編碼資料

### 3.1 審查前端程式碼中的硬編碼資料
- [ ] 搜尋 `const MOCK_` 或類似的 mock 資料
- [ ] 搜尋硬編碼的客戶、產品、報價單陣列
- [ ] 檢查下拉選單選項是否為硬編碼
- [ ] 列出所有需要移除的硬編碼資料

**驗證方式**：grep 搜尋結果不包含 mock 資料

---

### 3.2 替換為資料庫查詢
- [ ] 所有產品選項使用 `useProducts` hook
- [ ] 所有客戶選項使用 `useCustomers` hook
- [ ] 所有報價單使用 `useQuotations` hook
- [ ] 確認所有列表資料來自 API

**驗證方式**：清空資料庫後頁面顯示空狀態，而非假資料

---

### 3.3 加入空狀態處理
- [ ] 產品列表為空時顯示「建立第一個產品」提示
- [ ] 客戶列表為空時顯示「建立第一個客戶」提示
- [ ] 報價單列表為空時顯示「建立第一個報價單」提示
- [ ] 空狀態包含建立按鈕

**驗證方式**：清空資料庫後確認空狀態正確顯示

---

### 3.4 加入載入狀態
- [ ] 資料載入中顯示 spinner
- [ ] 使用 React Query 的 `isLoading` 狀態
- [ ] 避免閃爍（使用適當的 staleTime）

**驗證方式**：網路節流測試載入狀態

---

## Phase 4: 資料庫整合驗證

### 4.1 驗證 RLS 政策
- [ ] 測試使用者 A 無法查看使用者 B 的產品
- [ ] 測試使用者 A 無法編輯使用者 B 的產品
- [ ] 測試使用者 A 無法刪除使用者 B 的產品
- [ ] 確認匿名使用者無法存取任何資料

**驗證方式**：使用不同使用者帳號測試

---

### 4.2 驗證 CRUD 操作一致性
- [ ] 建立產品後立即可在列表查詢到
- [ ] 更新產品後列表顯示最新資料
- [ ] 刪除產品後列表移除該產品
- [ ] React Query 快取正確更新

**驗證方式**：執行完整的 CRUD 流程並確認資料一致

---

### 4.3 測試錯誤場景
- [ ] 網路錯誤時顯示適當錯誤訊息
- [ ] API 500 錯誤時顯示錯誤訊息
- [ ] 認證過期時引導使用者重新登入
- [ ] 表單驗證失敗時顯示明確錯誤

**驗證方式**：模擬各種錯誤情況

---

## Phase 5: 整合測試

### 5.1 端到端測試 - 產品流程
- [ ] 建立新產品並驗證資料庫
- [ ] 編輯產品並驗證更新
- [ ] 在報價單中選擇該產品
- [ ] 驗證單價自動帶入
- [ ] 刪除產品

**驗證方式**：完整執行產品生命週期

---

### 5.2 端到端測試 - 報價單流程
- [ ] 建立客戶
- [ ] 建立產品
- [ ] 建立報價單並新增產品
- [ ] 驗證單價自動帶入
- [ ] 修改數量並驗證小計更新
- [ ] 儲存報價單並驗證資料庫

**驗證方式**：完整執行報價單建立流程

---

### 5.3 多使用者測試
- [ ] 使用者 A 建立產品
- [ ] 使用者 B 無法看到使用者 A 的產品
- [ ] 使用者 B 建立自己的產品
- [ ] 兩個使用者各自看到自己的資料

**驗證方式**：使用兩個瀏覽器分別登入不同帳號

---

### 5.4 效能測試
- [ ] 產品列表載入時間 < 2 秒
- [ ] 報價單儲存時間 < 3 秒
- [ ] React Query 快取有效減少 API 呼叫
- [ ] 沒有不必要的重新渲染

**驗證方式**：使用 Chrome DevTools Performance tab

---

## Phase 6: 文件和清理

### 6.1 更新程式碼註解
- [ ] 為新增的邏輯加上清晰的註解
- [ ] 更新複雜函式的文件註解
- [ ] 移除過時的註解

**驗證方式**：Code review

---

### 6.2 清理無用程式碼
- [ ] 移除已註解的舊程式碼
- [ ] 移除未使用的 imports
- [ ] 移除未使用的變數和函式

**驗證方式**：執行 ESLint 並修復所有警告

---

### 6.3 執行 Lint 和 TypeCheck
- [ ] 執行 `npm run lint` 並修復所有錯誤
- [ ] 執行 `npm run typecheck` 並修復所有類型錯誤
- [ ] 確認沒有使用 `any` 類型

**驗證方式**：Lint 和 typecheck 無錯誤

---

### 6.4 更新測試文件
- [ ] 記錄測試結果到 TESTING_REPORT.md
- [ ] 列出已修復的 bug
- [ ] 列出測試過的場景
- [ ] 加入螢幕截圖（可選）

**驗證方式**：測試文件完整且清晰

---

## 依賴關係

```
Phase 1 (產品表單) → Phase 3 (移除硬編碼)
                   ↓
Phase 2 (自動帶入) → Phase 5 (整合測試)
                   ↓
Phase 4 (資料庫驗證) → Phase 6 (文件清理)
```

## 預估時間

- Phase 1: 4-6 小時
- Phase 2: 2-3 小時
- Phase 3: 2-3 小時
- Phase 4: 2-3 小時
- Phase 5: 3-4 小時
- Phase 6: 1-2 小時

**總計**：14-21 小時（約 2-3 個工作天）

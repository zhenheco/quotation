# quotation-payment-methods 變更提案

## 概述

在報價單建立和編輯流程中，新增付款方式選擇和備註功能，並在付款期別中新增「一次付清（100%）」選項。

## 動機

目前報價單系統只提供付款期別（分期付款比例）設定，但缺少以下關鍵功能：

1. **付款方式選擇**：無法記錄客戶偏好的付款方式（現金、匯款、虛擬幣、支票）
2. **付款備註**：無法記錄付款相關的重要資訊（如銀行帳號、支票號碼等）
3. **一次付清選項**：需要手動建立 100% 的付款期別，使用者體驗不佳

這些限制導致業務人員需要在外部記錄這些資訊，增加工作負擔且容易遺失資料。

## 目標

1. 在報價單中新增付款方式欄位（支援現代 B2B 付款方式）
2. 在付款期別中也支援付款方式選擇（覆蓋報價單預設值）
3. 新增付款備註欄位（文字輸入，支援帳號、票號等資訊）
4. 在付款期別編輯器中新增「一次付清（100%）」的快速選項
5. 提供條件式驗證和安全性提示
6. 確保這些資訊在報價單檢視、編輯、PDF 匯出時都能正確顯示

## 範圍

### 包含

- 報價單資料模型擴充（新增 `payment_method` 和 `payment_notes` 欄位）
- 付款期別資料模型擴充（新增 `payment_method` 欄位到 `payment_terms` 表）
- 支援 7 種現代 B2B 付款方式：
  - 現金（Cash）
  - 銀行匯款（Bank Transfer）
  - ACH/電子轉帳（ACH Transfer）
  - 信用卡（Credit Card）
  - 支票（Check）
  - 虛擬幣（Cryptocurrency）
  - 其他（Other）- 可自訂
- 報價單建立/編輯表單 UI 更新
- 付款期別編輯器新增快速選項
- 條件式 UI 提示
- PDF 匯出包含付款資訊
- API 路由更新以支援新欄位
- 資料庫 migration 腳本（PostgreSQL 和 D1）

### 不包含

- 合約系統的付款方式同步（將在後續變更中處理，但報價單轉合約時會保留付款資訊）
- 付款提醒功能
- 付款方式的深度驗證邏輯（如虛擬幣地址格式驗證、銀行帳號驗證）
- 實際付款處理整合（Payment Gateway）
- 付款方式統計報表
- 從客戶歷史推薦付款方式（未來功能）

## 限制條件

- 必須向下相容現有報價單（沒有付款方式和備註的報價單）
- 付款方式為可選欄位（允許留空）
- 付款備註最多 500 字元

## 相關變更

無。這是一個獨立的功能增強。

## 預期影響

### 資料庫

- `quotations` 表新增 2 個欄位：
  - `payment_method VARCHAR(50) NULL` - 預設付款方式
  - `payment_notes TEXT NULL` - 付款備註
- `payment_terms` 表新增 1 個欄位：
  - `payment_method VARCHAR(50) NULL` - 覆蓋報價單預設值（可選）
- 需要執行 migration（PostgreSQL 和 D1）
- 向下相容：現有資料欄位為 NULL

### API

- `POST /api/quotations` - 接受新欄位
- `PUT /api/quotations/[id]` - 接受新欄位
- `GET /api/quotations/[id]` - 回傳新欄位

### UI

- 報價單建立表單新增付款方式和備註區塊
- 報價單編輯表單新增付款方式和備註區塊
- 付款期別編輯器：
  - 新增「一次付清（100%）」快速按鈕
  - 每個期別可選擇付款方式（可選）
- 報價單詳情頁顯示付款方式和備註
- PDF 匯出包含完整付款資訊
- 條件式 UI 提示：
  - 選擇「匯款」時提示填寫銀行資訊
  - 根據付款方式動態調整備註 placeholder

### 效能

- 對查詢效能影響微小（新增 2 個簡單欄位）
- 不需要新增索引

## 業界研究發現

### B2B 付款方式趨勢（2025）

根據業界研究：

1. **主流付款方式**：
   - ACH 付款和支票是 2024 最常用方式
   - 2025 趨勢：移動支付（佔 79% 數位交易）、虛擬卡、即時付款（RTP）
   - 28% 企業已完全採用電子付款

2. **安全性考量**：
   - 電子付款（ACH、RTP）日益普及且快速
   - 企業傾向採用更安全的數位付款方式

3. **使用者期望**：
   - 客戶期望多種付款選項
   - 千禧世代和 Z 世代買家偏好數位付款
   - 一鍵付款和無接觸支付成為必備功能

### 資料庫設計最佳實踐

參考 Odoo 和其他 ERP 系統：

1. **付款條款結構**：
   - 在發票/報價單層級定義預設付款方式
   - 支援分期付款，每個期別可有獨立設定
   - 保留付款歷史和審計軌跡

2. **資料模型**：
   - 將付款方式存儲為 enum 或 VARCHAR
   - 使用 `payment_schedules` 表追蹤分期
   - 保持報價單和合約資料一致性

## 風險評估

**低風險**：這是一個純功能擴充，不影響現有核心邏輯。

### 潛在問題

1. **資料遷移**：現有報價單沒有這些欄位
   - **緩解**：使用 `ALTER TABLE ... ADD COLUMN` with `NULL` default

2. **類型安全**：TypeScript 類型需要更新
   - **緩解**：完整更新所有相關 interface 和 type

3. **UI 空間**：表單可能變得擁擠
   - **緩解**：使用可折疊區塊或分頁

4. **付款方式層級混淆**：報價單和期別都有付款方式
   - **緩解**：清楚的 UI 說明，期別付款方式為「覆蓋」而非「獨立」

## 驗收標準

### 基本功能

1. ✅ 使用者可在建立報價單時選擇付款方式（7 種選項）
2. ✅ 使用者可在建立報價單時輸入付款備註（最多 500 字元）
3. ✅ 付款期別可選擇付款方式（覆蓋報價單預設值）
4. ✅ 付款期別編輯器有「一次付清（100%）」按鈕
5. ✅ 點擊「一次付清」按鈕會自動建立一個 100% 的付款期別
6. ✅ 報價單詳情頁正確顯示付款方式和備註
7. ✅ PDF 匯出包含付款資訊

### 向下相容性

8. ✅ 編輯現有報價單時可以新增/修改付款方式和備註
9. ✅ 現有報價單（沒有這些欄位）仍可正常顯示和編輯
10. ✅ 現有付款期別正常運作，可選擇性新增付款方式

### UI 和驗證

11. ✅ 選擇「匯款」時 placeholder 提示輸入銀行資訊
12. ✅ 付款備註字數限制生效（500 字元）
13. ✅ 付款方式選項顯示多語系翻譯
14. ✅ 根據付款方式動態調整備註 placeholder

### 技術要求

15. ✅ 所有 TypeScript 類型檢查通過
16. ✅ Migration 腳本在 PostgreSQL 和 D1 上都能正確執行
17. ✅ API 正確處理新欄位的 CRUD 操作
18. ✅ 前端 UI 響應式設計正常

## 開放問題

1. **付款方式是否應該支援多選？**
   - 目前設計為單選（報價單層級和期別層級）
   - 如果未來需要支援多選（如「匯款 + 支票」），需要改為 JSONB array
   - **決策**：先實作單選，觀察使用者反饋
   - **理由**：業界研究顯示大部分 B2B 交易使用單一付款方式

2. **是否需要預設付款方式？**
   - 目前沒有系統預設值
   - 可能增加「公司設定」中的預設付款方式選項
   - **決策**：後續功能，不在此變更範圍
   - **替代方案**：使用者第一次選擇後，該客戶的付款方式會被記錄

3. **付款備註是否需要多語系？**
   - 目前設計為純文字（不分語系）
   - 大部分情況下備註為帳號、票號等，不需要翻譯
   - **決策**：使用純文字，不實作多語系
   - **理由**：帳號和票號等資訊不需要翻譯

4. **付款期別的付款方式是必填還是可選？**
   - 目前設計為可選（NULL）
   - 如果期別沒有指定，則繼承報價單層級的付款方式
   - **決策**：設為可選，提供彈性
   - **UI 提示**：如果報價單有預設值，期別顯示「使用預設：匯款」

5. **是否需要驗證付款方式和幣別的相容性？**
   - 例如：虛擬幣通常用 USD
   - 目前設計不強制驗證
   - **決策**：僅提供 UI 提示，不強制驗證
   - **理由**：保持彈性，避免限制特殊業務需求

## 參考資料

- [B2B Payments: Best Practices 2025](https://www.centime.com/posts/ultimate-guide-to-b2b-payments-in-2024)
- [Invoice Validation Best Practices](https://nanonets.com/blog/invoice-validation/)
- [Odoo Payment Terms Documentation](https://www.odoo.com/documentation/18.0/applications/finance/accounting/customer_invoices/payment_terms.html)
- [Database Design for Payment Systems - Stack Overflow](https://stackoverflow.com/questions/35135181/database-design-for-invoices-with-monthly-installments)

# Tasks: add-quotation-send-button

這是報價單寄送按鈕功能的實作任務清單。任務依照實作順序排列，並標註依賴關係。

---

## Phase 1: API 基礎設施

### 1.1 建立郵件服務模組
**檔案**: `lib/services/email.ts`
**描述**: 建立可重用的郵件發送服務，支援 Gmail SMTP
**依賴**: 無
**驗證**:
- [ ] Gmail SMTP 配置正確
- [ ] 可成功發送測試郵件
- [ ] 包含錯誤處理和重試機制
- [ ] TypeScript 類型完整

**預估時間**: 2-3 小時

---

### 1.2 建立郵件範本
**檔案**: `lib/templates/quotation-email.ts`
**描述**: 建立報價單郵件的 HTML 範本，支援中英文
**依賴**: 無
**驗證**:
- [ ] 中文範本完整
- [ ] 英文範本完整
- [ ] 範本變數正確替換
- [ ] HTML 格式在主要郵件客戶端正常顯示

**預估時間**: 2 小時

---

### 1.3 實作單一報價單寄送 API
**檔案**: `app/api/quotations/[id]/send/route.ts`
**描述**: 建立或修復單一報價單寄送端點
**依賴**: 1.1, 1.2
**驗證**:
- [ ] POST 方法正確實作
- [ ] 認證檢查（401 錯誤）
- [ ] 報價單存在檢查（404 錯誤）
- [ ] 客戶電子郵件檢查（400 錯誤）
- [ ] 郵件成功發送
- [ ] 報價單狀態更新為 'sent'
- [ ] 錯誤處理完整
- [ ] API 回傳格式符合規格

**預估時間**: 3-4 小時

---

### 1.4 實作批次報價單寄送 API
**檔案**: `app/api/quotations/batch/send/route.ts`
**描述**: 建立批次寄送端點
**依賴**: 1.1, 1.2, 1.3
**驗證**:
- [ ] POST 方法正確實作
- [ ] 批次數量限制（最多 50 個）
- [ ] 批次處理邏輯正確
- [ ] 部分成功時正確回傳結果
- [ ] 全部失敗時正確回傳錯誤
- [ ] 錯誤處理完整
- [ ] API 回傳格式符合規格

**預估時間**: 3-4 小時

---

## Phase 2: 前端整合

### 2.1 建立 React Query Hooks
**檔案**: `hooks/useQuotations.ts`
**描述**: 新增 `useSendQuotation` 和 `useBatchSendQuotations` hooks
**依賴**: 1.3, 1.4
**驗證**:
- [ ] `useSendQuotation` hook 正確實作
- [ ] `useBatchSendQuotations` hook 正確實作
- [ ] 成功時自動重新整理報價單列表
- [ ] 錯誤處理完整
- [ ] TypeScript 類型完整

**預估時間**: 1-2 小時

---

### 2.2 建立寄送確認彈窗組件
**檔案**: `components/quotations/SendQuotationModal.tsx`
**描述**: 實作寄送確認彈窗，包含郵件主旨和內容編輯
**依賴**: 無
**驗證**:
- [ ] 彈窗開啟/關閉正常
- [ ] 顯示報價單資訊（編號、客戶名稱、客戶電子郵件）
- [ ] 郵件主旨可編輯，預設值正確
- [ ] 郵件內容可編輯，預設值正確
- [ ] 載入狀態正確顯示
- [ ] 確認/取消按鈕功能正常
- [ ] RWD 響應式設計
- [ ] 無障礙支援（a11y）

**預估時間**: 3-4 小時

---

### 2.3 在報價單列表新增單一寄送按鈕
**檔案**: `app/[locale]/quotations/QuotationList.tsx`
**描述**: 在每一列的操作欄位新增寄送按鈕
**依賴**: 2.1, 2.2
**驗證**:
- [ ] 寄送按鈕顯示在正確位置（編輯和檢視之間）
- [ ] 按鈕樣式符合設計規格（綠色）
- [ ] 客戶沒有電子郵件時按鈕 disabled
- [ ] 點擊按鈕開啟寄送確認彈窗
- [ ] 彈窗傳入正確的報價單資料
- [ ] 寄送成功後顯示 toast 訊息
- [ ] 寄送失敗後顯示錯誤訊息

**預估時間**: 2-3 小時

---

### 2.4 新增批次寄送按鈕
**檔案**: `app/[locale]/quotations/QuotationList.tsx`
**描述**: 在批次操作區域新增批次寄送按鈕
**依賴**: 2.1, 2.2
**驗證**:
- [ ] 批次寄送按鈕顯示在正確位置
- [ ] 按鈕樣式符合設計規格（藍綠色）
- [ ] 顯示選擇的報價單數量
- [ ] 選擇的報價單中有無郵件的檢查
- [ ] 點擊按鈕開啟批次寄送確認彈窗
- [ ] 彈窗顯示即將寄送的報價單列表
- [ ] 批次寄送成功後顯示結果統計
- [ ] 部分失敗時顯示詳細資訊

**預估時間**: 2-3 小時

---

## Phase 3: 多語系支援

### 3.1 新增多語系翻譯
**檔案**: `messages/zh.json`, `messages/en.json`
**描述**: 新增所有寄送相關的翻譯字串
**依賴**: 無
**驗證**:
- [ ] 中文翻譯完整
- [ ] 英文翻譯完整
- [ ] 所有 UI 文字都有對應翻譯
- [ ] 錯誤訊息翻譯正確

**預估時間**: 1 小時

**翻譯清單**:
- `quotation.send` - 寄送
- `quotation.sendQuotation` - 寄送報價單
- `quotation.sendSuccess` - 報價單已成功寄送至 {email}
- `quotation.sendFailed` - 寄送失敗：{error}
- `quotation.sendConfirm.title` - 確認寄送報價單
- `quotation.sendConfirm.customerEmail` - 客戶電子郵件
- `quotation.sendConfirm.emailSubject` - 郵件主旨
- `quotation.sendConfirm.emailContent` - 郵件內容
- `quotation.sendConfirm.defaultSubject` - 報價單 #{number}
- `quotation.sendConfirm.send` - 確認寄送
- `quotation.sendConfirm.sending` - 寄送中...
- `quotation.noCustomerEmail` - 客戶沒有電子郵件地址
- `batch.send` - 批次寄送
- `batch.sendConfirm.title` - 批次寄送報價單
- `batch.sendConfirm.description` - 即將寄送 {count} 個報價單
- `batch.sendSuccess` - 已成功寄送 {sent} 個報價單
- `batch.sendPartialSuccess` - 已成功寄送 {sent} 個報價單，{failed} 個失敗
- `batch.sendFailed` - 批次寄送失敗

---

## Phase 4: 測試與驗證

### 4.1 單元測試
**檔案**: `__tests__/lib/services/email.test.ts`
**描述**: 測試郵件服務模組
**依賴**: 1.1
**驗證**:
- [ ] 郵件發送成功情境
- [ ] 郵件發送失敗情境
- [ ] 認證錯誤處理
- [ ] 範本變數替換正確

**預估時間**: 2 小時

---

### 4.2 API 整合測試
**檔案**: `tests/api/quotations-send.test.ts`
**描述**: 測試寄送 API 端點
**依賴**: 1.3, 1.4
**驗證**:
- [ ] 成功寄送單一報價單
- [ ] 客戶無郵件時回傳 400
- [ ] 報價單不存在時回傳 404
- [ ] 未認證時回傳 401
- [ ] 批次寄送成功
- [ ] 批次寄送部分成功
- [ ] 批次數量超過限制時回傳 400

**預估時間**: 3 小時

---

### 4.3 E2E 測試
**檔案**: `tests/e2e/send-quotation.spec.ts`
**描述**: 端對端測試寄送功能
**依賴**: 所有前端和後端實作完成
**驗證**:
- [ ] 可以開啟寄送確認彈窗
- [ ] 可以編輯郵件主旨和內容
- [ ] 可以成功寄送報價單
- [ ] 寄送後狀態更新為 'sent'
- [ ] 批次寄送功能正常
- [ ] 錯誤處理正確

**預估時間**: 2-3 小時

---

### 4.4 手動測試
**描述**: 在開發環境和 staging 環境進行手動測試
**依賴**: 所有實作完成
**驗證清單**:
- [ ] 測試單一報價單寄送（有客戶郵件）
- [ ] 測試單一報價單寄送（無客戶郵件）
- [ ] 測試批次寄送（所有客戶都有郵件）
- [ ] 測試批次寄送（部分客戶沒有郵件）
- [ ] 測試批次寄送（選擇 50 個以上報價單）
- [ ] 測試編輯郵件主旨和內容
- [ ] 測試中文和英文介面
- [ ] 測試各種錯誤情境
- [ ] 測試 RWD（手機、平板、桌面）
- [ ] 驗證實際收到的郵件格式正確

**預估時間**: 2 小時

---

### 4.5 修復測試中發現的問題
**描述**: 根據測試結果修復 bugs
**依賴**: 4.1, 4.2, 4.3, 4.4
**預估時間**: 2-4 小時（視問題數量而定）

---

## Phase 5: 文件與部署

### 5.1 更新 API 文件
**檔案**: `docs/api/openapi.yaml`
**描述**: 更新 OpenAPI 規格，包含新的寄送端點
**依賴**: 1.3, 1.4
**驗證**:
- [ ] 端點路徑正確
- [ ] Request/Response schema 正確
- [ ] 錯誤碼文件完整
- [ ] 範例請求和回應正確

**預估時間**: 1 小時

---

### 5.2 更新使用者文件
**檔案**: `docs/USER_GUIDE.md`（如果有）
**描述**: 新增寄送報價單功能的使用說明
**依賴**: 所有實作完成
**驗證**:
- [ ] 功能說明清楚
- [ ] 包含螢幕截圖
- [ ] 常見問題解答

**預估時間**: 1 小時

---

### 5.3 部署到 staging 環境
**描述**: 將功能部署到 staging 環境進行最終測試
**依賴**: 所有測試通過
**驗證**:
- [ ] 環境變數設定正確（Gmail 認證）
- [ ] API 端點正常運作
- [ ] 前端功能正常
- [ ] 郵件成功發送到測試信箱

**預估時間**: 1 小時

---

### 5.4 部署到 production 環境
**描述**: 將功能部署到正式環境
**依賴**: staging 測試通過
**驗證**:
- [ ] 環境變數設定正確
- [ ] 功能正常運作
- [ ] 監控和日誌正常

**預估時間**: 1 小時

---

## 總計預估時間

- **Phase 1 (API)**: 10-13 小時
- **Phase 2 (前端)**: 8-12 小時
- **Phase 3 (多語系)**: 1 小時
- **Phase 4 (測試)**: 9-12 小時
- **Phase 5 (文件與部署)**: 4 小時

**總計**: 32-42 小時（約 4-5.5 工作天）

---

## 並行任務建議

以下任務可以並行進行以加快開發速度：

1. **1.1 + 1.2** 可以同時開發（郵件服務和範本獨立）
2. **3.1** 可以在任何時候進行（多語系不依賴其他任務）
3. **2.2** 可以在 API 開發期間同時進行（使用 mock API）
4. **5.1 + 5.2** 可以在開發後期同時進行

---

## 風險與緩解

| 風險 | 影響 | 緩解措施 |
|------|------|----------|
| Gmail API 配額限制 | 中 | 實作速率限制，考慮使用專業郵件服務 |
| 郵件發送延遲 | 低 | 實作非同步處理（未來改進） |
| 批次處理超時 | 中 | 限制批次數量為 50，考慮使用背景任務 |
| 客戶資料不完整 | 低 | 完善的前端驗證和錯誤提示 |

---

## 驗收標準

功能開發完成並滿足以下所有標準時，可視為已完成：

1. ✅ 所有 API 端點正常運作並通過測試
2. ✅ UI 組件符合設計規格並通過 E2E 測試
3. ✅ 郵件成功發送到客戶信箱
4. ✅ 報價單狀態正確更新
5. ✅ 錯誤處理完整且使用者友善
6. ✅ 中英文介面完整
7. ✅ RWD 響應式設計正常
8. ✅ 無障礙支援符合 WCAG 2.1 AA 標準
9. ✅ 所有測試通過（單元、整合、E2E）
10. ✅ 文件完整且最新
11. ✅ 在 production 環境正常運作

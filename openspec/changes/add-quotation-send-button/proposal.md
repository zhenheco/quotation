# Proposal: add-quotation-send-button

## Overview
在報價單列表頁面的操作欄位新增「寄送」按鈕，允許使用者單獨或批次寄送報價單到客戶的電子郵件信箱。寄送前會顯示確認視窗，讓使用者確認收件人信箱及編輯郵件內容。

## Motivation
目前報價單系統雖然有寄送功能的 API 端點（但尚未完全運作），但在使用者介面上並沒有提供明確的寄送按鈕，導致使用者無法直覺地寄送報價單給客戶。此變更將新增一個使用者友善的介面，讓使用者可以輕鬆寄送報價單。

## Goals
1. 在報價單列表的每一列「編輯」按鈕旁新增「寄送」按鈕
2. 支援單一報價單寄送及批次寄送功能
3. 提供寄送確認視窗，顯示客戶電子郵件地址並允許編輯郵件主旨和內容
4. 寄送成功後自動更新報價單狀態為 'sent'
5. 修復並完善現有的寄送 API，確保郵件能成功發送

## Non-Goals
- 不在此階段實作郵件範本系統
- 不處理附件上傳功能（PDF 自動生成）
- 不實作郵件發送歷史記錄功能

## Scope
本提案涵蓋以下範圍：

### In Scope
1. **UI/UX 變更**：
   - 在報價單列表每一列新增「寄送」按鈕
   - 新增批次寄送按鈕（在批次操作區域）
   - 設計並實作寄送確認彈窗

2. **API 整合**：
   - 建立或修復單一報價單寄送 API
   - 建立批次報價單寄送 API
   - 整合郵件服務（Gmail API）

3. **資料驗證**：
   - 檢查客戶是否有電子郵件地址
   - 驗證郵件格式

4. **狀態管理**：
   - 寄送成功後更新報價單狀態為 'sent'
   - 更新前端狀態（使用 React Query）

### Out of Scope
- 郵件範本編輯器
- 進階郵件功能（排程發送、追蹤開啟率等）
- 郵件發送歷史記錄

## Success Criteria
1. 使用者可以在報價單列表點擊「寄送」按鈕
2. 系統顯示確認視窗，包含：
   - 客戶名稱和電子郵件地址
   - 可編輯的郵件主旨（預設值）
   - 可編輯的郵件內容（預設值）
3. 點擊確認後，報價單成功寄送到客戶信箱
4. 報價單狀態自動更新為 'sent'
5. 使用者收到成功或失敗的回饋訊息
6. 批次寄送功能正常運作，可同時寄送多個報價單

## Dependencies
- 現有的 Gmail 整合（`GMAIL_USER`, `GMAIL_APP_PASSWORD` 環境變數）
- Supabase 客戶資料表（包含客戶電子郵件）
- React Query mutation hooks
- next-intl 多語系支援

## Timeline
預估實作時間：2-3 天

**Phase 1: API 實作**（1 天）
- 建立或修復 `/api/quotations/[id]/send` 端點
- 建立 `/api/quotations/batch/send` 端點
- 整合郵件發送服務

**Phase 2: UI/UX 實作**（1 天）
- 新增寄送按鈕到 QuotationList
- 實作寄送確認彈窗組件
- 整合 React Query mutation

**Phase 3: 測試與除錯**（0.5-1 天）
- 功能測試
- 錯誤處理測試
- 郵件發送測試

## Alternatives Considered
1. **在報價單詳細頁面才提供寄送功能**
   - 優點：可以先預覽報價單內容
   - 缺點：操作步驟較多，不符合使用者期望的快速寄送流程

2. **直接寄送，不顯示確認視窗**
   - 優點：操作最快速
   - 缺點：沒有機會確認收件人信箱或自訂郵件內容，容易出錯

3. **使用第三方郵件服務（如 SendGrid, Resend）**
   - 優點：更穩定的郵件發送
   - 缺點：增加成本和複雜度，目前 Gmail API 已配置

## Risks
1. **郵件發送失敗**
   - 風險：Gmail API 可能因為各種原因失敗（網路、配額、認證等）
   - 緩解措施：完善的錯誤處理和使用者回饋，記錄錯誤日誌

2. **批次寄送效能問題**
   - 風險：同時寄送大量郵件可能導致超時或失敗
   - 緩解措施：限制批次數量上限，使用佇列處理（未來改進）

3. **客戶資料不完整**
   - 風險：客戶沒有電子郵件地址
   - 緩解措施：在寄送前驗證，顯示明確錯誤訊息

## Open Questions
1. 批次寄送的數量上限應該設定為多少？（建議：20-50 個）
2. 郵件發送失敗後是否要允許重試？（建議：是，但手動重試）
3. 是否要在寄送前強制檢查報價單狀態？（建議：允許重新寄送已發送的報價單）

## Related Changes
- 可能需要更新 `customers` 資料表以確保所有客戶都有電子郵件欄位
- 未來可能需要新增郵件發送歷史記錄功能（另外提案）
